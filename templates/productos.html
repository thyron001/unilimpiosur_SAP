<!-- templates/productos.html -->
<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Productos ‚Äî SAP</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
            rel="stylesheet">
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/glass.css') }}">
    </head>
    <body>
        <div class="app">
            <!-- Header -->
            <div class="header">
                <nav class="header-menu" aria-label="Secciones">
                    <a class="menu-link" href="/pedidos">Pedidos</a>
                    <a class="menu-link" href="/clientes">Clientes</a>
                    <a class="menu-link is-active"
                        href="/productos">Productos</a>
                    <a class="menu-link" href="/reportes">Reportes</a>
                </nav>
                <div class="search-bar">
                    <input type="text" id="busquedaRapida"
                        placeholder="Buscar en productos‚Ä¶">
                </div>
            </div>

            <div class="wrapper">
                <!-- Sidebar izquierda -->
                <aside class="left-side">
                    <section class="side-wrapper">
                        <h3 class="side-title">Opciones</h3>
                        <div class="side-menu">
                            <label class="chip"
                                style="cursor:pointer; user-select:none;">
                                <input type="checkbox" id="toggleEdicion"
                                    style="accent-color:#9fd5ff; margin-right:6px;">
                                üñäÔ∏è Modo edici√≥n
                            </label>
                            <button id="btnRefrescar" class="chip"
                                title="Recargar datos">‚Üª Refrescar</button>
                            <button id="btnSubirArchivos" class="chip"
                                title="Subir CSV/Excel con SKU, nombre, bodega">‚§¥Ô∏è
                                Subir archivos</button>
                        </div>
                    </section>
                </aside>

                <!-- Contenido principal -->
                <div class="main-container">
                    <div class="main-header">
                        <a class="menu-link main-header-link is-active"
                            href="#">Productos</a>
                    </div>

                    <div class="content-wrapper">
                        <!-- Bloque 1: productos mapeados POR CLIENTE -->
                        <section class="content-section" id="secPorCliente">
                            <h4 class="content-section-title">Bodega por
                                producto ‚Äî POR CLIENTE</h4>
                            <div id="listaPorCliente"
                                style="display:grid; gap:16px;"></div>
                        </section>

                        <!-- Bloque 2: productos mapeados POR SUCURSAL Y CLIENTE -->
                        <section class="content-section" id="secPorSucursal">
                            <h4 class="content-section-title">Bodega por
                                producto ‚Äî POR SUCURSAL Y CLIENTE</h4>
                            <div id="listaPorSucursal"
                                style="display:grid; gap:16px;"></div>
                        </section>
                    </div>
                </div>
            </div>
        </div>

        <!-- Datalist con cat√°logo (SKU / Nombre) para ayudar a escribir -->
        <datalist id="dlSkus"></datalist>
        <datalist id="dlNombres"></datalist>

        <style>
    .celda-editable { outline: 1px dashed var(--border-color); border-radius: 6px; }
    .marcada-borrado { opacity:.55; filter: grayscale(.4); }
    .btn-mini {
      appearance: none; cursor: pointer;
      border: 1px solid var(--border-color);
      background: var(--hover-menu-bg);
      color: var(--theme-color);
      border-radius: 8px; padding: 4px 8px; font-size: 12px;
    }
    .btn-mini:hover { filter: brightness(1.1); }
    .fila-nueva td { background: rgba(255,255,255,.03); }
    .subtitulo { color: var(--inactive-color); font-size: 13px; margin: 0 0 8px; }
  </style>

        <script>
  (function(){
    // ============================
    // Utilidades generales
    // ============================
    const $$  = (sel, ctx=document) => ctx.querySelector(sel);
    const $$$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const esc = (s)=> (s??"").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    function normalizarTexto(s){
      return (s||"").toString().toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ").trim();
    }

    function configurarCeldaEditable(td, habilitar){
      if(!td) return;
      if(habilitar){
        td.contentEditable = "true";
        td.classList.add("celda-editable");
      } else {
        td.removeAttribute("contenteditable");
        td.classList.remove("celda-editable");
      }
    }

    const toggleEdicion   = $$("#toggleEdicion");
    const btnRefrescar    = $$("#btnRefrescar");
    const inputBusqueda   = $$("#busquedaRapida");
    const contPorCliente  = $$("#listaPorCliente");
    const contPorSucursal = $$("#listaPorSucursal");

    // ============================
    // Datalist (cat√°logo productos)
    // ============================
    async function cargarCatalogo(){
      const resp = await fetch("/api/productos_catalogo");
      if(!resp.ok) throw new Error("No se pudo cargar el cat√°logo de productos.");
      const data = await resp.json(); // [{sku, nombre}]
      const dlSkus = $$("#dlSkus");   dlSkus.innerHTML = "";
      const dlNom  = $$("#dlNombres");dlNom.innerHTML  = "";
      for(const p of data){
        const opt1 = document.createElement("option"); opt1.value = p.sku;    dlSkus.appendChild(opt1);
        const opt2 = document.createElement("option"); opt2.value = p.nombre; dlNom.appendChild(opt2);
      }
      return data;
    }

    // ============================
    // Construcci√≥n de tablas
    // ============================
    function thsProductos(cantidadAlias = 0){ 
        let headersAlias = '';
        for(let i = 1; i <= cantidadAlias; i++) {
            headersAlias += `<th>Alias ${i}</th>`;
        }
        return `
        <tr>
            <th>SKU</th>
            <th>Nombre del Producto</th>
            ${headersAlias}
            <th class="col-bodega">Bodega</th>
            <th class="col-editar">Editar</th>
        </tr>`; 
    }

    function construirFilaProducto(row, editable, cantidadAlias = 0){
        const tr = document.createElement("tr");
        tr.dataset.mapeoId = row.mapeo_id ?? "";
        tr.dataset.productoId = row.producto_id ?? "";
        
        // Generar columnas de alias
        let celdasAlias = '';
        for(let i = 1; i <= cantidadAlias; i++) {
            const aliasValue = row[`alias_${i}`] || '';
            celdasAlias += `<td data-label="Alias ${i}"><span contenteditable="false" class="alias-${i}">${esc(aliasValue)}</span></td>`;
        }
        
        tr.innerHTML = `
            <td data-label="SKU"><span contenteditable="false" class="sku">${esc(row.sku||"")}</span></td>
            <td data-label="Nombre del Producto"><span contenteditable="false" class="nombre">${esc(row.nombre_producto||"")}</span></td>
            ${celdasAlias}
            <td data-label="Bodega" class="col-bodega"><span contenteditable="false" class="bodega">${esc(row.bodega||"")}</span></td>
            <td class="col-editar">
                <button class="btn-editar" data-accion="borrar" title="Marcar para borrar">üóëÔ∏è</button>
            </td>
        `;
        
        // Configurar celdas editables
        const spans = ["sku","nombre","bodega"].map(c=>tr.querySelector("."+c));
        spans.forEach(sp => {
            if(editable){
            sp.setAttribute("contenteditable","true");
            sp.classList.add("celda-editable");
            if(sp.classList.contains("sku"))    sp.setAttribute("list","dlSkus");
            if(sp.classList.contains("nombre")) sp.setAttribute("list","dlNombres");
            } else {
            sp.removeAttribute("contenteditable");
            sp.classList.remove("celda-editable");
            }
        });
        
        // Configurar celdas de alias editables
        for(let i = 1; i <= cantidadAlias; i++) {
            const aliasSpan = tr.querySelector(`.alias-${i}`);
            if(aliasSpan) {
                if(editable){
                    aliasSpan.setAttribute("contenteditable","true");
                    aliasSpan.classList.add("celda-editable");
                } else {
                    aliasSpan.removeAttribute("contenteditable");
                    aliasSpan.classList.remove("celda-editable");
                }
            }
        }
        
        tr.querySelector(".btn-editar[data-accion='borrar']").addEventListener("click", ()=>{
          tr.classList.toggle("marcada-borrado");
        });
        return tr;
        }

    function agregarFilaNueva(tbody, cantidadAlias = 0){
        const tr = document.createElement("tr");
        tr.className = "fila-nueva";
        
        // Generar columnas de alias
        let celdasAlias = '';
        for(let i = 1; i <= cantidadAlias; i++) {
            celdasAlias += `<td data-label="Alias ${i}"><span contenteditable="true" class="alias-${i} celda-editable"></span></td>`;
        }
        
        tr.innerHTML = `
            <td data-label="SKU"><span contenteditable="true" class="sku celda-editable" list="dlSkus"></span></td>
            <td data-label="Nombre del Producto"><span contenteditable="true" class="nombre celda-editable" list="dlNombres"></span></td>
            ${celdasAlias}
            <td data-label="Bodega" class="col-bodega"><span contenteditable="true" class="bodega celda-editable"></span></td>
            <td class="col-editar">
                <button class="btn-editar" data-accion="agregar" title="Agregar producto">Ôºã</button>
            </td>
        `;
        tbody.insertBefore(tr, tbody.firstChild);
        tr.querySelector(".btn-editar[data-accion='agregar']").addEventListener("click", ()=>{
            const sku   = tr.querySelector(".sku").textContent.trim();
            const nombre= tr.querySelector(".nombre").textContent.trim();
            const bodega= tr.querySelector(".bodega").textContent.trim();
            
            // Recopilar alias
            const alias = {};
            for(let i = 1; i <= cantidadAlias; i++) {
                const aliasSpan = tr.querySelector(`.alias-${i}`);
                if(aliasSpan) {
                    alias[`alias_${i}`] = aliasSpan.textContent.trim();
                }
            }
            
            if(!sku && !nombre){
            alert("‚ùå Error: Debe ingresar el SKU o el nombre del producto.\n\nPor favor, complete al menos uno de estos campos:\n‚Ä¢ SKU del producto\n‚Ä¢ Nombre del producto");
            return;
            }
            
            if(!bodega){
            alert("‚ùå Error: Debe ingresar la bodega del producto.\n\nPor favor, complete el campo 'Bodega' antes de agregar el producto.");
            return;
            }
            const nueva = construirFilaProducto({sku, nombre_producto:nombre, bodega, ...alias}, true, cantidadAlias);
            tr.before(nueva);
            tr.querySelector(".sku").textContent = "";
            tr.querySelector(".nombre").textContent = "";
            tr.querySelector(".bodega").textContent = "";
            // Limpiar alias
            for(let i = 1; i <= cantidadAlias; i++) {
                const aliasSpan = tr.querySelector(`.alias-${i}`);
                if(aliasSpan) {
                    aliasSpan.textContent = "";
                }
            }
        });
        }

    // Cards por cliente (caso POR CLIENTE)
    function construirCardPorCliente(bloque){
      const card = document.createElement("div");
      card.className = "card";
      const head = document.createElement("div");
      head.className = "card-head";
      head.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px;">
          <strong>${esc(bloque.cliente.nombre)}</strong>
          <span class="chip mono">RUC: ${esc(bloque.cliente.ruc||"-")}</span>
        </div>
        <div class="chip">Bodega por Cliente</div>
      `;
      
      // Contenedor del contenido (tabla)
      const content = document.createElement("div");
      content.className = "card-content";
      
      // Determinar cantidad de alias
      const cantidadAlias = bloque.cliente.alias_por_producto ? (bloque.cliente.cantidad_alias_producto || 1) : 0;
      
      const wrap = document.createElement("div");
      wrap.className = "table-wrap";
      wrap.innerHTML = `
        <table class="glass-table tabla-por-cliente" data-cliente-id="${bloque.cliente.id}" data-cantidad-alias="${cantidadAlias}">
          <thead>${thsProductos(cantidadAlias)}</thead>
          <tbody></tbody>
        </table>
      `;
      content.appendChild(wrap);
      card.appendChild(head); 
      card.appendChild(content);

      const tbody = wrap.querySelector("tbody");
      
      // Agregar fila nueva al inicio si edici√≥n activa
      if(toggleEdicion.checked) agregarFilaNueva(tbody, cantidadAlias);
      
      for(const r of (bloque.filas||[])){
        tbody.appendChild(construirFilaProducto(r, toggleEdicion.checked, cantidadAlias));
      }

      // Cargar estado persistente del acorde√≥n
      const clienteKey = `producto_cliente_accordion_${bloque.cliente.id}`;
      const isExpandedStored = localStorage.getItem(clienteKey) === 'true';
      
      if (isExpandedStored) {
        head.classList.add("expanded");
        content.classList.add("expanded");
      }

      // Event listener para el acorde√≥n
      head.addEventListener("click", (e) => {
        const isExpanded = head.classList.contains("expanded");
        if (isExpanded) {
          head.classList.remove("expanded");
          content.classList.remove("expanded");
          localStorage.setItem(clienteKey, 'false');
        } else {
          head.classList.add("expanded");
          content.classList.add("expanded");
          localStorage.setItem(clienteKey, 'true');
        }
      });

      return card;
    }

    // Cards por cliente ‚Üí subtablas por sucursal (caso POR SUCURSAL Y CLIENTE)
    function construirCardPorSucursal(grupo){
      // Contenedor por CLIENTE (puede tener varias sucursales)
      const card = document.createElement("div");
      card.className = "card";
      const head = document.createElement("div");
      head.className = "card-head";
      head.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px;">
          <strong>${esc(grupo.cliente.nombre)}</strong>
          <span class="chip mono">RUC: ${esc(grupo.cliente.ruc||"-")}</span>
        </div>
        <div class="chip">Bodega por Sucursal</div>
      `;
      card.appendChild(head);

      // Contenedor del contenido
      const content = document.createElement("div");
      content.className = "card-content";

      // Sucursales anidadas
      const cont = document.createElement("div");
      cont.className = "table-wrap";

      // agrupamos por sucursal_id dentro del grupo
      const porSuc = {};
      for(const b of (grupo.bloques||[])){
        (porSuc[b.sucursal.id] ||= { sucursal: b.sucursal, filas: [] }).filas.push(...(b.filas||[]));
      }

      // Determinar cantidad de alias del cliente
      const cantidadAlias = grupo.cliente.alias_por_producto ? (grupo.cliente.cantidad_alias_producto || 1) : 0;

      for(const sid of Object.keys(porSuc)){
        const data = porSuc[sid];
        const subtitulo = document.createElement("p");
        subtitulo.className = "subtitulo";
        subtitulo.textContent = `Sucursal: ${data.sucursal.nombre}`;
        cont.appendChild(subtitulo);

        const tabla = document.createElement("table");
        tabla.className = "glass-table tabla-por-sucursal";
        tabla.setAttribute("data-sucursal-id", data.sucursal.id);
        tabla.setAttribute("data-cantidad-alias", cantidadAlias);
        tabla.innerHTML = `<thead>${thsProductos(cantidadAlias)}</thead><tbody></tbody>`;
        const tbody = tabla.tBodies[0];
        
        // Agregar fila nueva al inicio si edici√≥n activa
        if(toggleEdicion.checked) agregarFilaNueva(tbody, cantidadAlias);
        
        for(const r of (data.filas||[])){
          tbody.appendChild(construirFilaProducto(r, toggleEdicion.checked, cantidadAlias));
        }
        cont.appendChild(tabla);
      }

      content.appendChild(cont);
      card.appendChild(content);

      // Cargar estado persistente del acorde√≥n
      const clienteKey = `producto_sucursal_accordion_${grupo.cliente.id}`;
      const isExpandedStored = localStorage.getItem(clienteKey) === 'true';
      
      if (isExpandedStored) {
        head.classList.add("expanded");
        content.classList.add("expanded");
      }

      // Event listener para el acorde√≥n
      head.addEventListener("click", (e) => {
        const isExpanded = head.classList.contains("expanded");
        if (isExpanded) {
          head.classList.remove("expanded");
          content.classList.remove("expanded");
          localStorage.setItem(clienteKey, 'false');
        } else {
          head.classList.add("expanded");
          content.classList.add("expanded");
          localStorage.setItem(clienteKey, 'true');
        }
      });

      return card;
    }

    // ============================
    // Carga y render
    // ============================
    function aplicarFiltroBusqueda(q){
      const nq = normalizarTexto(q);
      for(const card of $$$(".card")){
        let hasMatches = false;
        
        // Buscar en el header del cliente
        const header = card.querySelector(".card-head");
        const headerText = normalizarTexto(header.innerText);
        const headerMatches = headerText.includes(nq);
        
        // Buscar en todas las filas de todas las tablas dentro de la tarjeta
        const rows = card.querySelectorAll("tbody tr");
        for(const row of rows){
          const rowText = normalizarTexto(row.innerText);
          const rowMatches = rowText.includes(nq);
          
          if(rowMatches){
            row.style.display = "";
            hasMatches = true;
          } else {
            row.style.display = "none";
          }
        }
        
        // Mostrar/ocultar la tarjeta completa si hay coincidencias en header o filas
        if(headerMatches || hasMatches){
          card.style.display = "";
          // Si hay coincidencias en filas, expandir la tarjeta
          if(hasMatches && !headerMatches){
            const head = card.querySelector(".card-head");
            const content = card.querySelector(".card-content");
            head.classList.add("expanded");
            content.classList.add("expanded");
          }
        } else {
          card.style.display = "none";
        }
      }
    }

    function renderizar(data){
      contPorCliente.innerHTML  = "";
      contPorSucursal.innerHTML = "";
      for(const bloque of (data.por_cliente || [])){
        contPorCliente.appendChild(construirCardPorCliente(bloque));
      }
      for(const grupo of (data.por_sucursal || [])){
        contPorSucursal.appendChild(construirCardPorSucursal(grupo));
      }
      // Solo aplicar filtro si hay texto en la b√∫squeda
      if(inputBusqueda.value.trim() !== ""){
        aplicarFiltroBusqueda(inputBusqueda.value);
      }
    }

    async function cargarDatos(){
      const resp = await fetch("/api/productos_mapeos");
      if(!resp.ok) throw new Error("No se pudo cargar el mapeo de productos.");
      return resp.json();
    }

    // ============================
    // Guardado (bulk)
    // ============================
    function recolectarCambiosPorCliente(){
        const cambios = [];
        for(const t of $$$(".tabla-por-cliente")){
            const clienteId = Number(t.dataset.clienteId);
            const cantidadAlias = Number(t.dataset.cantidadAlias) || 0;
            for(const tr of $$$("tbody tr", t)){
            if(tr.classList.contains("fila-nueva")) continue;
            const sku    = tr.querySelector(".sku").textContent.trim();
            const nombre = tr.querySelector(".nombre").textContent.trim();
            const bodega = tr.querySelector(".bodega").textContent.trim();
            const borrar = tr.classList.contains("marcada-borrado");
            const mapeoId= tr.dataset.mapeoId ? Number(tr.dataset.mapeoId) : null;
            
            // Recopilar alias
            const alias = {};
            for(let i = 1; i <= cantidadAlias; i++) {
                const aliasSpan = tr.querySelector(`.alias-${i}`);
                if(aliasSpan) {
                    alias[`alias_${i}`] = aliasSpan.textContent.trim();
                }
            }
            
            cambios.push({ cliente_id: clienteId, producto_sku: sku, producto_nombre: nombre, bodega, mapeo_id: mapeoId, borrar, ...alias });
            }
        }
        return cambios;
        }

    function recolectarCambiosPorSucursal(){
        const cambios = [];
        for(const t of $$$(".tabla-por-sucursal")){
            const sucursalId = Number(t.dataset.sucursalId);
            const cantidadAlias = Number(t.dataset.cantidadAlias) || 0;
            for(const tr of $$$("tbody tr", t)){
            if(tr.classList.contains("fila-nueva")) continue;
            const sku    = tr.querySelector(".sku").textContent.trim();
            const nombre = tr.querySelector(".nombre").textContent.trim();
            const bodega = tr.querySelector(".bodega").textContent.trim();
            const borrar = tr.classList.contains("marcada-borrado");
            const mapeoId= tr.dataset.mapeoId ? Number(tr.dataset.mapeoId) : null;
            
            // Recopilar alias
            const alias = {};
            for(let i = 1; i <= cantidadAlias; i++) {
                const aliasSpan = tr.querySelector(`.alias-${i}`);
                if(aliasSpan) {
                    alias[`alias_${i}`] = aliasSpan.textContent.trim();
                }
            }
            
            cambios.push({ sucursal_id: sucursalId, producto_sku: sku, producto_nombre: nombre, bodega, mapeo_id: mapeoId, borrar, ...alias });
            }
        }
        return cambios;
        }

    async function guardarCambios(){
      const porCli = recolectarCambiosPorCliente();
      const porSuc = recolectarCambiosPorSucursal();
      if(porCli.length===0 && porSuc.length===0) return;

      const peticiones = [];
      if(porCli.length > 0){
        peticiones.push(fetch("/api/productos_por_cliente/bulk", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cambios: porCli })
        }));
      }
      if(porSuc.length > 0){
        peticiones.push(fetch("/api/productos_por_sucursal/bulk", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cambios: porSuc })
        }));
      }

      const rs = await Promise.all(peticiones);
      for(const r of rs){
        if(!r.ok){
          const tx = await r.text().catch(()=> "");
          throw new Error("Fallo al guardar: " + tx);
        }
      }
    }

    function activarEdicionUI(habilitar){
        // Agregar/quitar clase modo-edicion al contenedor principal
        const app = $$(".app");
        if(habilitar){
          app.classList.add("modo-edicion");
        }else{
          app.classList.remove("modo-edicion");
        }
        
        // Alternar celdas + fila nueva
        for(const tabla of $$$(".tabla-por-cliente, .tabla-por-sucursal")){
            const tbody = tabla.tBodies[0];
            const cantidadAlias = parseInt(tabla.dataset.cantidadAlias) || 0;
            
            for(const tr of $$$("tr", tbody)){
            if(tr.classList.contains("fila-nueva")) continue;
            
            // Configurar celdas b√°sicas
            ["sku","nombre","bodega"].forEach(cls=>{
                const sp = tr.querySelector("."+cls);
                if(!sp) return; // por si acaso
                configurarCeldaEditable(sp, habilitar);
                if(habilitar && (cls==="sku"||cls==="nombre")){
                sp.setAttribute("list", cls==="sku" ? "dlSkus" : "dlNombres");
                } else {
                sp.removeAttribute("list");
                }
            });
            
            // Configurar celdas de alias
            for(let i = 1; i <= cantidadAlias; i++) {
                const aliasSpan = tr.querySelector(`.alias-${i}`);
                if(aliasSpan) {
                    configurarCeldaEditable(aliasSpan, habilitar);
                }
            }
            }
            const existe = tbody.querySelector(".fila-nueva");
            if(habilitar){
            if(!existe) agregarFilaNueva(tbody, cantidadAlias);
            }else{
            if(existe) existe.remove();
            }
        }
        }

    // ============================
    // Inicializaci√≥n
    // ============================
    async function inicializar(){
      try{
        await cargarCatalogo();
        const data = await cargarDatos();
        renderizar(data);
      }catch(e){
        console.error(e);
        alert(e.message || "Error al inicializar Productos.");
      }
    }

    toggleEdicion.addEventListener("change", async ()=>{
      if(!toggleEdicion.checked){
        // Al apagar edici√≥n, guardamos
        try{
          await guardarCambios();
          await inicializar(); // recargar para refrescar IDs
        }catch(e){
          console.error(e);
          alert(e.message || "Error al guardar.");
          toggleEdicion.checked = true;
          activarEdicionUI(true);
          return;
        }
      }
      activarEdicionUI(toggleEdicion.checked);
    });

    inputBusqueda.addEventListener("input", ()=>{
      const q = inputBusqueda.value.trim();
      if(q === ""){
        // Limpiar filtros y restaurar todas las filas
        for(const card of $$$(".card")){
          card.style.display = "";
          const rows = card.querySelectorAll("tbody tr");
          for(const row of rows){
            row.style.display = "";
          }
        }
      } else {
        aplicarFiltroBusqueda(q);
      }
    });
    btnRefrescar.addEventListener("click", inicializar);

    inicializar();
  })();
  </script>

        <!-- ================= Modal Subir Archivos ================= -->
        <div id="modalSubir" class="modal-backdrop" style="display:none;">
            <div class="modal-card">
                <div class="modal-head">
                    <strong>Subir productos (CSV / Excel)</strong>
                    <button class="btn-mini" id="btnCerrarModal"
                        aria-label="Cerrar">‚úñ</button>
                </div>

                <div class="modal-body">
                    <div class="campo">
                        <label for="inputArchivo"><b>Archivo</b> (columnas:
                            <code>SKU</code>, <code>nombre</code>,
                            <code>bodega</code>)</label>
                        <input id="inputArchivo" type="file"
                            accept=".csv,.xlsx" />
                        <small>Usa .csv (UTF-8) o .xlsx. Si vas a crear
                            productos nuevos, <u>SKU es obligatorio</u>.</small>
                    </div>

                    <div class="campo">
                        <label for="selectCliente"><b>Cliente</b></label>
                        <select id="selectCliente"></select>
                        <small id="ayudaCliente" class="ayuda"></small>
                    </div>

                    <div class="campo" id="bloqueSucursal"
                        style="display:none;">
                        <label for="selectSucursal"><b>Sucursal</b> (solo si el
                            cliente usa bodega por sucursal)</label>
                        <select id="selectSucursal"></select>
                    </div>
                </div>

                <div class="modal-foot">
                    <button class="btn-mini" id="btnSubirEjecutar">Subir y
                        actualizar</button>
                </div>
            </div>
        </div>

        <style>
            .modal-backdrop{
            position: fixed; inset: 0; background: rgba(0,0,0,.45);
            display: grid; place-items: center; z-index: 9999;
            }
            .modal-card{
            width: min(720px, 96vw);
            background: var(--content-bg);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,.3);
            padding: 12px 12px 14px;
            }
            .modal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom: 10px; }
            .modal-body{ display:grid; gap:12px; }
            .modal-foot{ display:flex; justify-content:flex-end; margin-top: 6px; }
            .campo label{ display:block; margin-bottom: 6px; }
            .campo input[type="file"], .campo select{
            width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--hover-menu-bg); color: var(--theme-color);
            }
            .ayuda{ color: var(--inactive-color); }
        </style>

        <script>
        (function(){
        // --------- Referencias del modal
        const btnSubirArchivos = document.getElementById("btnSubirArchivos");
        const modalSubir       = document.getElementById("modalSubir");
        const btnCerrarModal   = document.getElementById("btnCerrarModal");
        const inputArchivo     = document.getElementById("inputArchivo");
        const selectCliente    = document.getElementById("selectCliente");
        const selectSucursal   = document.getElementById("selectSucursal");
        const bloqueSucursal   = document.getElementById("bloqueSucursal");
        const ayudaCliente     = document.getElementById("ayudaCliente");
        const btnSubirEjecutar = document.getElementById("btnSubirEjecutar");

        let cacheClientes = [];  // [{id, nombre, ruc, usa_bodega_por_sucursal, sucursales:[{id,nombre,...}]}]
        let mapaClientes  = {};  // id -> cliente
        let mapaSucursales= {};  // id -> sucursal

        async function cargarClientesParaModal(){
            // Reutilizamos /api/clientes_con_sucursales (ya la tienes)
            const r = await fetch("/api/clientes_con_sucursales");
            if(!r.ok) throw new Error("No se pudo cargar clientes.");
            cacheClientes = await r.json();
            mapaClientes = {};
            selectCliente.innerHTML = "";
            for(const c of cacheClientes){
            mapaClientes[c.id] = c;
            const opt = document.createElement("option");
            opt.value = String(c.id);
            opt.textContent = `${c.nombre} (RUC: ${c.ruc})`;
            selectCliente.appendChild(opt);
            }
            // Inicializa sucursales para el primer cliente
            actualizarUIClienteSeleccionado();
        }

        function actualizarUIClienteSeleccionado(){
            const id = Number(selectCliente.value);
            const cli = mapaClientes[id];
            if(!cli) return;

            ayudaCliente.textContent = cli.usa_bodega_por_sucursal
            ? "Este cliente usa asignaci√≥n de bodega por sucursal. Debes elegir la sucursal."
            : "Este cliente usa asignaci√≥n de bodega por cliente.";

            if(cli.usa_bodega_por_sucursal){
            bloqueSucursal.style.display = "";
            selectSucursal.innerHTML = "";
            mapaSucursales = {};
            for(const s of (cli.sucursales || [])){
                mapaSucursales[s.id] = s;
                const opt = document.createElement("option");
                opt.value = String(s.id);
                opt.textContent = s.nombre;
                selectSucursal.appendChild(opt);
            }
            if(selectSucursal.options.length === 0){
                // No hay sucursales activas -> avisar
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "‚Äî Sin sucursales activas ‚Äî";
                selectSucursal.appendChild(opt);
            }
            }else{
            bloqueSucursal.style.display = "none";
            selectSucursal.innerHTML = "";
            }
        }

        function abrirModal(){
            modalSubir.style.display = "grid";
            inputArchivo.value = "";
        }
        function cerrarModal(){
            modalSubir.style.display = "none";
        }

        async function enviarArchivo(){
            const archivo = inputArchivo.files?.[0];
            if(!archivo){
            alert("Selecciona un archivo CSV o XLSX con columnas: SKU, nombre, bodega.");
            return;
            }
            const cliente_id = Number(selectCliente.value);
            if(!cliente_id){
            alert("Selecciona un cliente.");
            return;
            }
            const cli = mapaClientes[cliente_id];
            let sucursal_id = "";
            if(cli?.usa_bodega_por_sucursal){
            sucursal_id = selectSucursal.value || "";
            if(!sucursal_id){
                alert("Selecciona una sucursal.");
                return;
            }
            }

            const fd = new FormData();
            fd.append("archivo", archivo, archivo.name);
            fd.append("cliente_id", String(cliente_id));
            if(sucursal_id) fd.append("sucursal_id", String(sucursal_id));

            btnSubirEjecutar.disabled = true;
            btnSubirEjecutar.textContent = "Subiendo‚Ä¶";

            try{
            const r = await fetch("/api/subir_productos", { method:"POST", body: fd });
            const js = await r.json().catch(()=> ({}));
            if(!r.ok || js.ok === false){
                const msg = js.error || `Fallo al subir (${r.status})`;
                throw new Error(msg);
            }
            // Informe
            const { insertados=0, actualizados=0, omitidos=0, errores=[] } = js;
            alert(
                `Actualizaci√≥n completada:\n`+
                `- Insertados: ${insertados}\n`+
                `- Actualizados: ${actualizados}\n`+
                `- Omitidos: ${omitidos}\n`+
                (errores?.length ? `- Errores: ${errores.length}\nEj:\n${errores.slice(0,3).join("\n")}` : "")
            );
            cerrarModal();
            // Reload de datos
            await inicializar();
            }catch(e){
            console.error(e);
            alert(e.message || "No se pudo procesar el archivo.");
            }finally{
            btnSubirEjecutar.disabled = false;
            btnSubirEjecutar.textContent = "Subir y actualizar";
            }
        }

        // Eventos
        btnSubirArchivos?.addEventListener("click", async ()=>{
            try{
            await cargarClientesParaModal();
            abrirModal();
            }catch(e){
            console.error(e);
            alert(e.message || "No se pudo abrir el modal de subida.");
            }
        });
        btnCerrarModal?.addEventListener("click", cerrarModal);
        modalSubir?.addEventListener("click", (ev)=>{
            if(ev.target === modalSubir) cerrarModal(); // cerrar al hacer click fuera
        });
        selectCliente?.addEventListener("change", actualizarUIClienteSeleccionado);
        btnSubirEjecutar?.addEventListener("click", enviarArchivo);
        })();
        </script>

    </body>
</html>
