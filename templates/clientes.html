<!-- templates/clientes.html -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Clientes ‚Äî SAP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/glass.css') }}">
  </head>
  <body>
    <div class="app">
      <!-- Header -->
      <div class="header">
        <nav class="header-menu" aria-label="Secciones">
          <a class="menu-link" href="/pedidos">Pedidos</a>
          <a class="menu-link is-active" href="/clientes">Clientes</a>
          <a class="menu-link" href="/productos">Productos</a>
          <a class="menu-link" href="/reportes">Reportes</a>
        </nav>
        <div class="search-bar">
          <input type="text" id="busquedaRapida" placeholder="Buscar en clientes/sucursales‚Ä¶">
        </div>
      </div>

      <div class="wrapper">
        <!-- Sidebar izquierda -->
        <aside class="left-side">
          <section class="side-wrapper">
            <h3 class="side-title">Opciones</h3>
            <div class="side-menu">
              <label class="chip" style="cursor:pointer; user-select:none;">
                <input type="checkbox" id="toggleEdicion" style="accent-color:#9fd5ff; margin-right:6px;">
                üñäÔ∏è Modo edici√≥n
              </label>
              <button id="btnRefrescar" class="chip" title="Recargar datos">‚Üª Refrescar</button>
            </div>
          </section>

        </aside>

        <!-- Contenido principal -->
        <div class="main-container">
          <div class="main-header">
            <a class="menu-link main-header-link is-active" href="#">Clientes</a>
          </div>

          <div class="content-wrapper">
            <section class="content-section" id="seccionClientes">
              <h4 class="content-section-title">Sucursales por cliente</h4>
              <!-- Contenedor donde se inyectar√°n las tarjetas por cliente -->
              <div id="listaClientes" style="display:grid; gap:16px;"></div>
            </section>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay + Modal Editar Cliente -->
    <div id="modalOverlayEditar" class="glass-overlay hidden"></div>

    <div id="modalEditarCliente" class="glass-modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalEditarTitle">
      <div class="glass-modal-card">
        <div class="glass-modal-head">
          <h3 id="modalEditarTitle" class="mono">Editar Cliente</h3>
          <button id="btnCerrarEditar" class="btn-close" aria-label="Cerrar">‚úï</button>
        </div>

        <div class="glass-modal-sub">
          <div><strong>Cliente:</strong> <span id="m-cliente-nombre">-</span></div>
          <div><strong>RUC:</strong> <span id="m-cliente-ruc">-</span></div>
        </div>

        <div class="glass-modal-body">
          <form id="formEditarCliente">
            <div class="glass-form-group">
              <label for="editNombre" class="glass-label">Nombre del Cliente</label>
              <input type="text" id="editNombre" class="glass-input" required>
            </div>

            <div class="glass-form-group">
              <label for="editRuc" class="glass-label">RUC</label>
              <input type="text" id="editRuc" class="glass-input" required maxlength="13">
            </div>

            <div class="glass-form-group">
              <label class="glass-label">Tipo de Bodega</label>
              <div class="glass-radio-group">
                <label class="glass-radio">
                  <input type="radio" id="editBodegaPor" name="bodegaPor" value="cliente">
                  <span class="glass-radio-text">Bodega por Cliente</span>
                </label>
                <label class="glass-radio">
                  <input type="radio" id="editBodegaPorSucursal" name="bodegaPor" value="sucursal">
                  <span class="glass-radio-text">Bodega por Sucursal</span>
                </label>
              </div>
            </div>

            <div class="glass-form-group">
              <label class="glass-label">Configuraci√≥n de Alias</label>
              <div class="glass-checkbox-group">
                <label class="glass-checkbox">
                  <input type="checkbox" id="editAliasPorSucursal">
                  <span class="glass-checkbox-text">Activar Alias por Sucursal</span>
                </label>
                <small class="glass-help">Si est√° activado, se mostrar√° el campo "Alias (PDF)" en las sucursales</small>
              </div>
              
              <div class="glass-checkbox-group">
                <label class="glass-checkbox">
                  <input type="checkbox" id="editAliasPorProducto">
                  <span class="glass-checkbox-text">Activar Alias por Producto</span>
                </label>
                <small class="glass-help">Si est√° activado, se podr√°n configurar alias para productos</small>
              </div>

              <div class="glass-form-group" id="campoCantidadAlias" style="display:none;">
                <label for="editCantidadAlias" class="glass-label">Cantidad de Alias por Producto</label>
                <select id="editCantidadAlias" class="glass-select">
                  <option value="1">1 Alias</option>
                  <option value="2">2 Alias</option>
                  <option value="3">3 Alias</option>
                </select>
              </div>
            </div>
          </form>
        </div>

        <div class="glass-modal-foot">
          <button id="btnGuardarCliente" class="glass-btn glass-btn-primary">üíæ Guardar</button>
          <button id="btnCancelarEditar" class="glass-btn glass-btn-secondary">‚ùå Cancelar</button>
        </div>
      </div>
    </div>

    <script>
    (function(){
      // ============================
      // Utilidades
      // ============================
      const $$  = (sel, ctx=document) => ctx.querySelector(sel);
      const $$$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

      const listaClientes = $$("#listaClientes");
      const toggleEdicion = $$("#toggleEdicion");
      const inputBusqueda = $$("#busquedaRapida");
      const btnRefrescar  = $$("#btnRefrescar");

      // Normalizar texto para b√∫squedas
      function normalizarTexto(s){
        return (s||"").toString().toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
          .replace(/\s+/g," ").trim();
      }

      // Formatear una celda como editable/no editable
      function configurarCeldaEditable(td, habilitar){
        if(habilitar){
          td.contentEditable = "true";
          td.classList.add("celda-editable");
        }else{
          td.removeAttribute("contenteditable");
          td.classList.remove("celda-editable");
        }
      }

      // Crear fila vac√≠a al final de la tabla cuando est√° en modo edici√≥n
      function agregarFilaVacia(tbody, cliente){
        const tr = document.createElement("tr");
        tr.className = "fila-nueva";
        
        // Determinar si mostrar columna de alias
        const tabla = tbody.closest('table');
        const mostrarAlias = tabla.dataset.mostrarAlias === 'true';
        const celdaAlias = mostrarAlias ? '<td data-label="Alias (PDF)"></td>' : '';
        
        tr.innerHTML = `
          <td data-label="Nombre (sistema)"></td>
          ${celdaAlias}
          <td data-label="Direcci√≥n"></td>
          <td data-label="Tel√©fono"></td>
          <td class="col-editar">
            <button class="btn-editar" data-accion="agregar" title="Agregar sucursal">Ôºã</button>
          </td>
        `;
        tbody.insertBefore(tr, tbody.firstChild);

        // Hacer celdas editables - ajustar seg√∫n si hay columna de alias
        const celdasEditables = mostrarAlias ? 4 : 3;
        $$$("td", tr).slice(0, celdasEditables).forEach(td=>configurarCeldaEditable(td, true));

        // Acci√≥n guardar nueva fila a la tabla (no env√≠a todav√≠a al backend)
        tr.querySelector(".btn-editar[data-accion='agregar']").addEventListener("click", ()=>{
          const celdas = $$$("td", tr).slice(0, celdasEditables);
          let nombre, alias, direccion, telefono;
          
          if (mostrarAlias) {
            [nombre, alias, direccion, telefono] = celdas.map(td=>td.textContent.trim());
          } else {
            [nombre, direccion, telefono] = celdas.map(td=>td.textContent.trim());
            alias = "";
          }
          
          if(!nombre){
            alert("‚ùå Error: Debe ingresar el nombre de la sucursal.\n\nPor favor, complete el campo 'Nombre (sistema)' antes de agregar la sucursal.");
            return;
          }
          const nueva = construirFilaSucursal({
            id: null, // se crear√° en backend
            nombre, alias, direccion, telefono
          }, /*editable=*/true, mostrarAlias);
          tr.before(nueva);
          // limpiar la fila vac√≠a
          celdas.forEach(td=>td.textContent = "");
        });
      }

      // Construir una fila de sucursal
      function construirFilaSucursal(suc, editable, mostrarAlias = true){
        const tr = document.createElement("tr");
        tr.dataset.sucursalId = suc.id ?? "";
        
        const celdaAlias = mostrarAlias ? `<td data-label="Alias (PDF)">${esc(suc.alias || "")}</td>` : '';
        
        tr.innerHTML = `
          <td data-label="Nombre (sistema)">${esc(suc.nombre)}</td>
          ${celdaAlias}
          <td data-label="Direcci√≥n">${esc(suc.direccion || "")}</td>
          <td data-label="Tel√©fono">${esc(suc.telefono || "")}</td>
          <td class="col-editar">
            <button class="btn-editar" data-accion="borrar" title="Marcar para borrar">üóëÔ∏è</button>
          </td>
        `;
        
        // editable ON/OFF - ajustar seg√∫n si hay columna de alias
        const celdasEditables = mostrarAlias ? 4 : 3;
        $$$("td", tr).slice(0, celdasEditables).forEach(td=>configurarCeldaEditable(td, editable));
        
        // borrar (solo marca; se eliminar√° al guardar)
        tr.querySelector(".btn-editar[data-accion='borrar']").addEventListener("click", ()=>{
          tr.classList.toggle("marcada-borrado");
        });
        return tr;
      }

      // Construir tarjeta de un cliente con su tabla
      function construirTarjetaCliente(cliente){
        const card = document.createElement("div");
        card.className = "card";

        // Encabezado
        const head = document.createElement("div");
        head.className = "card-head";
        head.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px;">
            <strong>${esc(cliente.nombre)}</strong>
            <span class="chip mono">RUC: ${esc(cliente.ruc)}</span>
          </div>
          <div style="display:flex; align-items:center; gap:10px;">
            <div class="chip">${cliente.usa_bodega_por_sucursal ? "Bodega por Sucursal" : "Bodega por Cliente"}</div>
            <button class="btn-editar-cliente" data-cliente-id="${cliente.id}" title="Editar cliente">‚úèÔ∏è Editar</button>
          </div>
        `;
        card.appendChild(head);

        // Contenedor del contenido (tabla)
        const content = document.createElement("div");
        content.className = "card-content";

        // Tabla
        const wrap = document.createElement("div");
        wrap.className = "table-wrap";
        
        // Determinar si mostrar columna de alias
        const mostrarAlias = cliente.alias_por_sucursal || false;
        const headerAlias = mostrarAlias ? '<th>Alias (PDF)</th>' : '';
        
        wrap.innerHTML = `
          <table class="glass-table tabla-sucursales" data-cliente-id="${cliente.id}" data-mostrar-alias="${mostrarAlias}">
            <thead>
              <tr>
                <th>Nombre (sistema)</th>
                ${headerAlias}
                <th>Direcci√≥n</th>
                <th>Tel√©fono</th>
                <th class="col-editar">Editar</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        `;
        content.appendChild(wrap);
        card.appendChild(content);

        // Cargar filas
        const tbody = $$("tbody", wrap);
        
        // Agregar fila vac√≠a al inicio si edici√≥n activa
        if(toggleEdicion.checked){
          agregarFilaVacia(tbody, cliente);
        }
        
        for(const s of (cliente.sucursales || [])){
          tbody.appendChild(construirFilaSucursal(s, /*editable=*/toggleEdicion.checked, mostrarAlias));
        }

        // Cargar estado persistente del acorde√≥n
        const clienteKey = `cliente_accordion_${cliente.id}`;
        const isExpandedStored = localStorage.getItem(clienteKey) === 'true';
        
        if (isExpandedStored) {
          head.classList.add("expanded");
          content.classList.add("expanded");
        }

        // Event listener para el acorde√≥n
        head.addEventListener("click", (e) => {
          // Evitar que se active si se hace clic en el bot√≥n de editar
          if (e.target.classList.contains("btn-editar-cliente") || e.target.closest(".btn-editar-cliente")) {
            return;
          }
          
          const isExpanded = head.classList.contains("expanded");
          if (isExpanded) {
            head.classList.remove("expanded");
            content.classList.remove("expanded");
            localStorage.setItem(clienteKey, 'false');
          } else {
            head.classList.add("expanded");
            content.classList.add("expanded");
            localStorage.setItem(clienteKey, 'true');
          }
        });

        return card;
      }

      // Escapar HTML
      function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

      // Renderizar lista completa
      function renderizarClientes(data){
        listaClientes.innerHTML = "";
        if(!data || !Array.isArray(data)){
          console.error("Datos de clientes inv√°lidos:", data);
          return;
        }
        for(const cli of data){
          try {
            listaClientes.appendChild(construirTarjetaCliente(cli));
          } catch(e) {
            console.error("Error al construir tarjeta para cliente:", cli, e);
          }
        }
        // Solo aplicar filtro si hay texto en la b√∫squeda
        if(inputBusqueda.value.trim() !== ""){
          aplicarFiltroBusqueda(inputBusqueda.value);
        }
      }

      // Filtro de b√∫squeda en tiempo real
      function aplicarFiltroBusqueda(q){
        const nq = normalizarTexto(q);
        for(const card of $$$(".card", listaClientes)){
          let hasMatches = false;
          
          // Buscar en el header del cliente
          const header = card.querySelector(".card-head");
          const headerText = normalizarTexto(header.innerText);
          const headerMatches = headerText.includes(nq);
          
          // Buscar en las filas de la tabla
          const rows = card.querySelectorAll("tbody tr");
          for(const row of rows){
            const rowText = normalizarTexto(row.innerText);
            const rowMatches = rowText.includes(nq);
            
            if(rowMatches){
              row.style.display = "";
              hasMatches = true;
            } else {
              row.style.display = "none";
            }
          }
          
          // Mostrar/ocultar la tarjeta completa si hay coincidencias en header o filas
          if(headerMatches || hasMatches){
            card.style.display = "";
            // Si hay coincidencias en filas, expandir la tarjeta
            if(hasMatches && !headerMatches){
              const head = card.querySelector(".card-head");
              const content = card.querySelector(".card-content");
              head.classList.add("expanded");
              content.classList.add("expanded");
            }
          } else {
            card.style.display = "none";
          }
        }
      }

      // Activar/Desactivar edici√≥n (UI)
      function activarEdicionUI(habilitar){
        // Agregar/quitar clase modo-edicion al contenedor principal
        const app = $$(".app");
        if(habilitar){
          app.classList.add("modo-edicion");
        }else{
          app.classList.remove("modo-edicion");
        }
        
        // Todas las filas de todas las tablas
        const tablas = $$$(".tabla-sucursales");
        for(const table of tablas){
          const tbody = table.tBodies[0];
          const mostrarAlias = table.dataset.mostrarAlias === 'true';
          const celdasEditables = mostrarAlias ? 4 : 3;
          
          // celdas editables
          $$$("tr", tbody).forEach(tr=>{
            $$$("td", tr).slice(0, celdasEditables).forEach(td=>configurarCeldaEditable(td, habilitar));
          });
          // fila extra para nuevas sucursales
          const existente = $$("tr.fila-nueva", tbody);
          if(habilitar){
            if(!existente) agregarFilaVacia(tbody, {id: table.dataset.clienteId});
          }else{
            if(existente) existente.remove();
          }
        }
      }

      // Recolectar cambios para guardar (altas, ediciones, bajas)
      function recolectarCambios(){
        const payload = [];
        for(const table of $$$(".tabla-sucursales")){
          const clienteId = Number(table.dataset.clienteId);
          const mostrarAlias = table.dataset.mostrarAlias === 'true';
          const tbody = table.tBodies[0];
          for(const tr of $$$("tr", tbody)){
            if(tr.classList.contains("fila-nueva")) continue; // no recolectar esta
            const celdas = $$$("td", tr);
            
            let obj;
            if (mostrarAlias) {
              obj = {
                cliente_id: clienteId,
                sucursal_id: tr.dataset.sucursalId ? Number(tr.dataset.sucursalId) : null,
                nombre:   celdas[0].textContent.trim(),
                alias:    celdas[1].textContent.trim(),
                direccion:celdas[2].textContent.trim(),
                telefono: celdas[3].textContent.trim(),
                borrar:   tr.classList.contains("marcada-borrado")
              };
            } else {
              obj = {
                cliente_id: clienteId,
                sucursal_id: tr.dataset.sucursalId ? Number(tr.dataset.sucursalId) : null,
                nombre:   celdas[0].textContent.trim(),
                alias:    "", // No hay columna de alias
                direccion:celdas[1].textContent.trim(),
                telefono: celdas[2].textContent.trim(),
                borrar:   tr.classList.contains("marcada-borrado")
              };
            }
            
            // ignorar filas completamente vac√≠as
            const tieneAlgo = obj.nombre || obj.alias || obj.direccion || obj.telefono || obj.sucursal_id || obj.borrar;
            if(tieneAlgo) payload.push(obj);
          }
        }
        return payload;
      }

      // Guardar cambios (bulk). Ajusta esta URL a tu backend.
      async function guardarCambios(){
        const cambios = recolectarCambios();
        if(cambios.length === 0) return;

        const resp = await fetch("/api/sucursales/bulk", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cambios })
        });
        if(!resp.ok){
          const tx = await resp.text().catch(()=> "");
          throw new Error("No se pudo guardar cambios. " + tx);
        }
        return resp.json();
      }

      // Cargar datos desde backend. Estructura esperada:
      // [
      //   { id, nombre, ruc, usa_bodega_por_sucursal, sucursales:[
      //       { id, nombre, alias, direccion, telefono }, ...
      //   ]}, ...
      // ]
      async function cargarClientes(){
        const resp = await fetch("/api/clientes_con_sucursales");
        if(!resp.ok) throw new Error("No se pudo cargar la lista de clientes.");
        return resp.json();
      }

      // ============================
      // Inicializaci√≥n
      // ============================
      let cacheClientes = [];

      async function inicializar(){
        try{
          cacheClientes = await cargarClientes();
          console.log("Clientes cargados:", cacheClientes); // Debug
          renderizarClientes(cacheClientes);
        }catch(e){
          console.error(e);
          alert(e.message || "Error al cargar clientes.");
        }
      }

      toggleEdicion.addEventListener("change", async ()=>{
        if(!toggleEdicion.checked){
          // Se desactiva edici√≥n => guardamos
          try{
            const r = await guardarCambios();
            // Tras guardar, recargamos para reflejar IDs creados y limpiar marcas
            await inicializar();
          }catch(e){
            console.error(e);
            alert(e.message || "Error al guardar.");
            // Si falla el guardado, mantenemos edici√≥n encendida para corregir
            toggleEdicion.checked = true;
            activarEdicionUI(true);
            return;
          }
        }
        activarEdicionUI(toggleEdicion.checked);
      });

      inputBusqueda.addEventListener("input", ()=>{
        const q = inputBusqueda.value.trim();
        if(q === ""){
          // Limpiar filtros y restaurar todas las filas
          for(const card of $$$(".card", listaClientes)){
            card.style.display = "";
            const rows = card.querySelectorAll("tbody tr");
            for(const row of rows){
              row.style.display = "";
            }
          }
        } else {
          aplicarFiltroBusqueda(q);
        }
      });
      btnRefrescar.addEventListener("click", inicializar);

      // ============================
      // Funcionalidad de edici√≥n de cliente
      // ============================
      const overlayEditar = $$("#modalOverlayEditar");
      const modalEditarCliente = $$("#modalEditarCliente");
      const btnCerrarEditar = $$("#btnCerrarEditar");
      const btnCancelarEditar = $$("#btnCancelarEditar");
      const btnGuardarCliente = $$("#btnGuardarCliente");
      const formEditarCliente = $$("#formEditarCliente");
      const campoCantidadAlias = $$("#campoCantidadAlias");
      const editAliasPorProducto = $$("#editAliasPorProducto");


      let clienteEditando = null;

      // Funci√≥n para abrir modal de edici√≥n
      function abrirModalEditar(cliente) {
        clienteEditando = cliente;
        
        // Llenar informaci√≥n en glass-modal-sub
        $$("#m-cliente-nombre").textContent = cliente.nombre || "-";
        $$("#m-cliente-ruc").textContent = cliente.ruc || "-";
        
        // Llenar formulario con datos del cliente
        $$("#editNombre").value = cliente.nombre || "";
        $$("#editRuc").value = cliente.ruc || "";
        
        // Configurar radio buttons
        if (cliente.usa_bodega_por_sucursal) {
          $$("#editBodegaPorSucursal").checked = true;
        } else {
          $$("#editBodegaPor").checked = true;
        }
        
        // Configurar checkboxes
        $$("#editAliasPorSucursal").checked = Boolean(cliente.alias_por_sucursal);
        $$("#editAliasPorProducto").checked = Boolean(cliente.alias_por_producto);
        
        // Configurar cantidad de alias
        $$("#editCantidadAlias").value = cliente.cantidad_alias_producto || 1;
        
        // Mostrar/ocultar campo de cantidad de alias
        actualizarVisibilidadCantidadAlias();
        
        // Mostrar modal
        overlayEditar.classList.remove("hidden");
        modalEditarCliente.classList.remove("hidden");
      }

      // Funci√≥n para cerrar modal
      function cerrarModalEditar() {
        overlayEditar.classList.add("hidden");
        modalEditarCliente.classList.add("hidden");
        clienteEditando = null;
        formEditarCliente.reset();
      }

      // Funci√≥n para actualizar visibilidad del campo cantidad de alias
      function actualizarVisibilidadCantidadAlias() {
        if (editAliasPorProducto.checked) {
          campoCantidadAlias.style.display = "block";
        } else {
          campoCantidadAlias.style.display = "none";
        }
      }

      // Funci√≥n para guardar cambios del cliente
      async function guardarCliente() {
        if (!clienteEditando) return;

        const datos = {
          nombre: $$("#editNombre").value.trim(),
          ruc: $$("#editRuc").value.trim(),
          usa_bodega_por_sucursal: $$("#editBodegaPorSucursal").checked,
          alias_por_sucursal: $$("#editAliasPorSucursal").checked,
          alias_por_producto: $$("#editAliasPorProducto").checked,
          cantidad_alias_producto: parseInt($$("#editCantidadAlias").value)
        };

        // Validaciones
        if (!datos.nombre) {
          alert("‚ùå Error: El nombre del cliente es obligatorio.\n\nPor favor, ingrese el nombre del cliente antes de guardar.");
          return;
        }
        if (!datos.ruc) {
          alert("‚ùå Error: El RUC es obligatorio.\n\nPor favor, ingrese el RUC del cliente antes de guardar.");
          return;
        }

        try {
          const resp = await fetch(`/api/clientes/${clienteEditando.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(datos)
          });

          if (!resp.ok) {
            const error = await resp.json();
            throw new Error(error.error || "Error al guardar cliente");
          }

          alert("‚úÖ Cliente actualizado correctamente");
          cerrarModalEditar();
          await inicializar(); // Recargar datos
        } catch (error) {
          console.error(error);
          alert(`‚ùå Error: ${error.message}`);
        }
      }

      // Event listeners para el modal
      if (editAliasPorProducto) {
        editAliasPorProducto.addEventListener("change", actualizarVisibilidadCantidadAlias);
      }
      if (btnCerrarEditar) {
        btnCerrarEditar.addEventListener("click", cerrarModalEditar);
      }
      if (btnCancelarEditar) {
        btnCancelarEditar.addEventListener("click", cerrarModalEditar);
      }
      if (btnGuardarCliente) {
        btnGuardarCliente.addEventListener("click", guardarCliente);
      }

      // Cerrar modal al hacer click fuera
      if (overlayEditar) {
        overlayEditar.addEventListener("click", (e) => {
          if (e.target === overlayEditar) {
            cerrarModalEditar();
          }
        });
      }

      // Cerrar modal con Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && overlayEditar && !overlayEditar.classList.contains("hidden")) {
          cerrarModalEditar();
        }
      });

      // Delegaci√≥n de eventos para botones de editar
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("btn-editar-cliente")) {
          const clienteId = parseInt(e.target.dataset.clienteId);
          const cliente = cacheClientes.find(c => c.id === clienteId);
          if (cliente) {
            abrirModalEditar(cliente);
          }
        }
      });

      // Arranque
      inicializar();
    })();
    </script>

    <style>
    /* Ajustes m√≠nimos encima del glass.css existente */
    .celda-editable { outline: 1px dashed var(--border-color); border-radius: 6px; }
    .marcada-borrado { opacity: .5; filter: grayscale(0.4); }
    .btn-mini {
      appearance: none; cursor: pointer;
      border: 1px solid var(--border-color);
      background: var(--hover-menu-bg);
      color: var(--theme-color);
      border-radius: 8px; padding: 4px 8px; font-size: 12px;
    }
    .btn-mini:hover { filter: brightness(1.1); }
    .fila-nueva td { background: rgba(255,255,255,.03); }
    
    /* Estilos para el bot√≥n de editar cliente */
    .btn-editar-cliente {
      appearance: none;
      cursor: pointer;
      border: 1px solid var(--border-color);
      background: var(--hover-menu-bg);
      color: var(--theme-color);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    .btn-editar-cliente:hover {
      filter: brightness(1.1);
      background: rgba(102, 126, 234, 0.2);
    }

    /* Estilos para el modal de edici√≥n */

    .glass-overlay.hidden {
      display: none;
    }
    
    .glass-modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .glass-modal-body {
      display: grid;
      gap: 12px;
    }
    .glass-modal-foot {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }
    .btn-close {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }
    .campo {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .campo label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    .campo input[type="text"], .campo select {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--hover-menu-bg);
      color: var(--text-color);
      font-size: 0.9rem;
    }
    .campo input[type="checkbox"], .campo input[type="radio"] {
      accent-color: #9fd5ff;
    }
    .campo small {
      color: var(--inactive-color);
      font-size: 0.8rem;
    }

    /* Estilos para formularios glass */
    .glass-form-group {
      margin-bottom: 16px;
    }
    .glass-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text-color);
    }
    .glass-input, .glass-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--content-bg);
      color: var(--text-color);
      font-size: 14px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .glass-input:focus, .glass-select:focus {
      outline: none;
      border-color: var(--theme-color);
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }
    .glass-radio-group, .glass-checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .glass-radio, .glass-checkbox {
      display: flex;
      align-items: center;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.2s ease;
    }
    .glass-radio:hover, .glass-checkbox:hover {
      background: rgba(255,255,255,0.05);
    }
    .glass-radio input, .glass-checkbox input {
      margin: 0 8px 0 0;
      width: auto;
    }
    .glass-radio-text, .glass-checkbox-text {
      font-size: 14px;
      color: var(--text-color);
    }
    .glass-help {
      display: block;
      margin-top: 4px;
      color: var(--text-muted);
      font-size: 12px;
      line-height: 1.4;
    }
    .glass-btn {
      appearance: none;
      cursor: pointer;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .glass-btn-primary {
      background: var(--theme-color);
      color: white;
      border-color: var(--theme-color);
    }
    .glass-btn-primary:hover {
      background: var(--theme-hover);
      border-color: var(--theme-hover);
    }
    .glass-btn-secondary {
      background: var(--content-bg);
      color: var(--text-color);
    }
    .glass-btn-secondary:hover {
      background: var(--hover-menu-bg);
    }
    </style>
  </body>
</html>
