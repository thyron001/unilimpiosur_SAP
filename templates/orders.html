<!-- =============================
Pedidos Dashboard ‚Äî Glassmorphism (oscuro fijo)
Secci√≥n 1: HTML (templates/pedidos.html)
Secci√≥n 2: CSS  (static/css/glass.css)
============================= -->

<!-- ======= Secci√≥n 1: templates/pedidos.html ======= -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pedidos ‚Äî SAP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet">
    <link rel="stylesheet"
      href="{{ url_for('static', filename='css/glass.css') }}">
  </head>
  <body>
    <div class="app">
      <!-- Header superior (sin menu-circle, sin profile, sin toggle de tema) -->
      <div class="header">
        <nav class="header-menu" aria-label="Secciones">
          <a class="menu-link is-active" href="#">Pedidos</a>
          <a class="menu-link" href="/clientes">Clientes</a>
          <a class="menu-link" href="/productos">Productos</a>
          <a class="menu-link" href="#">Reportes</a>
        </nav>
        <div class="search-bar">
          <input type="text" id="quickSearch" placeholder="Buscar en pedidos‚Ä¶">
        </div>
      </div>

      <div class="wrapper">
        <!-- Sidebar izquierda -->
        <aside class="left-side">
          <section class="side-wrapper">
            <h3 class="side-title">Filtros</h3>
            <div class="side-menu">
              <div class="filter-container">
                <div class="filter-chip" id="filter-cliente" data-filter="cliente">
                  <span class="filter-label">Cliente:</span>
                  <span class="filter-value">Todos</span>
                  <span class="filter-clear">√ó</span>
                </div>
                <div class="filter-dropdown" id="dropdown-cliente">
                  <div class="cliente-option" data-cliente-id="0">
                    <span class="cliente-nombre">Todos los clientes</span>
                  </div>
                  <div id="clientes-container"></div>
                </div>
              </div>
              
              <div class="filter-container">
                <div class="filter-chip" id="filter-desde" data-filter="desde">
                  <span class="filter-label">Desde:</span>
                  <span class="filter-value">Todos</span>
                  <span class="filter-clear">√ó</span>
                </div>
                <!-- Calendario personalizado glassmorphism -->
                <div class="glass-calendar" id="calendar-desde">
                  <div class="calendar-header">
                    <button class="calendar-nav" id="prev-desde">‚Äπ</button>
                    <span class="calendar-month-year" id="month-year-desde"></span>
                    <button class="calendar-nav" id="next-desde">‚Ä∫</button>
                  </div>
                  <div class="calendar-weekdays">
                    <div class="weekday">L</div>
                    <div class="weekday">M</div>
                    <div class="weekday">X</div>
                    <div class="weekday">J</div>
                    <div class="weekday">V</div>
                    <div class="weekday">S</div>
                    <div class="weekday">D</div>
                  </div>
                  <div class="calendar-days" id="days-desde"></div>
                </div>
              </div>
              
              <div class="filter-container">
                <div class="filter-chip" id="filter-hasta" data-filter="hasta">
                  <span class="filter-label">Hasta:</span>
                  <span class="filter-value">Todos</span>
                  <span class="filter-clear">√ó</span>
                </div>
                <!-- Calendario personalizado glassmorphism -->
                <div class="glass-calendar" id="calendar-hasta">
                  <div class="calendar-header">
                    <button class="calendar-nav" id="prev-hasta">‚Äπ</button>
                    <span class="calendar-month-year" id="month-year-hasta"></span>
                    <button class="calendar-nav" id="next-hasta">‚Ä∫</button>
                  </div>
                  <div class="calendar-weekdays">
                    <div class="weekday">L</div>
                    <div class="weekday">M</div>
                    <div class="weekday">X</div>
                    <div class="weekday">J</div>
                    <div class="weekday">V</div>
                    <div class="weekday">S</div>
                    <div class="weekday">D</div>
                  </div>
                  <div class="calendar-days" id="days-hasta"></div>
                </div>
              </div>
            </div>
          </section>
          <section class="side-wrapper">
            <h3 class="side-title">Configuraci√≥n</h3>
            <div class="side-menu">
              <div class="config-item">
                <label for="numeroPedidoInicial" class="config-label">
                  üìã N√∫mero de pedido inicial
                </label>
                <input type="number" id="numeroPedidoInicial" 
                       class="config-input" 
                       placeholder="Ej: 10000"
                       min="1">
                <button id="btnGuardarNumero" class="chip" 
                        title="Guardar n√∫mero de pedido inicial">
                  üíæ Guardar
                </button>
              </div>
            </div>
          </section>
        </aside>

        <!-- Contenido principal -->
        <div class="main-container">
          <div class="main-header">
            <a class="menu-link main-header-link" href="#" data-estado="por_procesar">Por procesar</a>
            <a class="menu-link main-header-link" href="#" data-estado="procesado">Procesado</a>
            <a class="menu-link main-header-link" href="#" data-estado="con_errores">Con errores</a>
          </div>

          <div class="content-wrapper">
            <!-- (Se removi√≥ el content-wrapper-header / hero) -->

            <!-- Secci√≥n de la tabla -->
            <section class="content-section" id="pedidos">
              <h4 class="content-section-title">Listado</h4>
              <div class="card">
                <div class="card-head">
                  <div style="display:flex; align-items:center; gap:10px;">
                    <strong>Pedidos</strong>
                    <span id="estado-actual" class="chip">{{ estado_actual or 'por_procesar' }}</span>
                  </div>
                </div>
                <div class="table-wrap">
                  <table id="ordersTable" class="glass-table">
                    <thead>
                      <tr>
                          <th class="col-checkbox" title="Seleccionar todos">
                            <input type="checkbox" id="selectAllCheckbox" class="glass-checkbox">
                          </th>
                        <th># Pedido</th>
                        <th>Cliente</th>
                        <th>Sucursal</th>
                        <th>Fecha</th>
                        <th>Origen</th>
                      </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                      {% for o in orders %}
                      <tr class="row-pedido" data-pedido-id="{{ o.id }}" role="button" tabindex="0" title="Ver detalle">
                        <td class="col-checkbox" data-label="Seleccionar">
                          <input type="checkbox" class="glass-checkbox pedido-checkbox" data-pedido-id="{{ o.id }}">
                        </td>
                        <td class="mono" data-label="# Pedido">{{ o.numero_pedido }}</td>
                        <td data-label="Cliente">Roldan</td>
                        <td data-label="Sucursal">{{ o.sucursal or '-' }}</td>
                        <td data-label="Fecha">{{ o.fecha.strftime('%Y-%m-%d %H:%M:%S') if o.fecha else '' }}</td>
                        <td data-label="Origen">Email</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- Bot√≥n flotante SAP (solo visible en "Por procesar") -->
            <div id="btnSAP" class="button-wrap btn-flotante-sap hidden" title="Generar archivos SAP">
              <button>
              <span>SAP</span>
            </button>
              <div class="button-shadow"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Overlay + Modal Detalle Pedido -->
    <div id="modalOverlay" class="glass-overlay hidden"></div>

    <div id="modalDetalle" class="glass-modal hidden" role="dialog"
      aria-modal="true" aria-labelledby="modalTitle">
      <div class="glass-modal-card">
        <div class="glass-modal-head">
          <h3 id="modalTitle" class="mono">Pedido <span
              id="m-numero"></span></h3>
          <button id="m-cerrar" class="btn-close" aria-label="Cerrar">‚úï</button>
        </div>

        <div class="glass-modal-sub">
          <div><strong>Sucursal:</strong> <span id="m-sucursal">-</span></div>
          <div><strong>Fecha:</strong> <span id="m-fecha">-</span></div>
        </div>

        <div class="glass-modal-body">
          <div class="table-wrap">
            <table class="glass-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Descripci√≥n</th>
                  <th class="num">Cant.</th>
                </tr>
              </thead>
              <tbody id="m-items"></tbody>
            </table>
          </div>
        </div>

        <!-- Recuadro de verificaci√≥n para pedidos con errores -->
        <div id="verificacion-container" class="glass-modal-verificacion" style="display: none;">
          <div class="glass-modal-verificacion-content">
            <h3>Verificaci√≥n de Errores</h3>
            <p>Este pedido contiene errores que requieren verificaci√≥n. Por favor, revisa y corrige los problemas antes de procesar.</p>
            <button id="btn-verificar" class="glass-btn glass-btn-primary" onclick="window.verificarPedido()">
              <i class="icon">‚úì</i>
              Verificar
            </button>
          </div>
        </div>

      </div>
    </div>


    <style>
    /* Estilos para configuraci√≥n */
    .config-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .config-label {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 4px;
    }
    
    .config-input {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 0.9rem;
        transition: border-color 0.2s ease;
    }
    
    .config-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px rgba(159, 213, 255, 0.2);
    }
    
    /* Defs */
    @property --angle-1 {
      syntax: "<angle>";
      inherits: false;
      initial-value: -75deg;
    }

    @property --angle-2 {
      syntax: "<angle>";
      inherits: false;
      initial-value: -45deg;
    }

    /* Variables para el bot√≥n */
    :root {
      --global--size: clamp(2rem, 4vw, 5rem);
      --anim--hover-time: 400ms;
      --anim--hover-ease: cubic-bezier(0.25, 1, 0.5, 1);
    }

    /* Estilos para el bot√≥n flotante SAP - Glass Button Style */
    .btn-flotante-sap {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
    }

    /* Button Wrap Container */
    .button-wrap {
      z-index: 2;
      border-radius: 999vw;
      background: transparent;
      pointer-events: none;
      transition: all var(--anim--hover-time) var(--anim--hover-ease);
    }

    /* Button Shadow Container */
    .button-shadow {
      --shadow-cuttoff-fix: 2em;
      position: absolute;
      width: calc(100% + var(--shadow-cuttoff-fix));
      height: calc(100% + var(--shadow-cuttoff-fix));
      top: calc(0% - var(--shadow-cuttoff-fix) / 2);
      left: calc(0% - var(--shadow-cuttoff-fix) / 2);
      filter: blur(clamp(2px, 0.125em, 12px));
      -webkit-filter: blur(clamp(2px, 0.125em, 12px));
      -moz-filter: blur(clamp(2px, 0.125em, 12px));
      -ms-filter: blur(clamp(2px, 0.125em, 12px));
      overflow: visible;
      pointer-events: none;
    }

    /* Shadow */
    .button-shadow::after {
      content: "";
      position: absolute;
      z-index: 0;
      inset: 0;
      border-radius: 999vw;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.1));
      width: calc(100% - var(--shadow-cuttoff-fix) - 0.25em);
      height: calc(100% - var(--shadow-cuttoff-fix) - 0.25em);
      top: calc(var(--shadow-cuttoff-fix) - 0.5em);
      left: calc(var(--shadow-cuttoff-fix) - 0.875em);
      padding: 0.125em;
      box-sizing: border-box;
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask-composite: exclude;
      transition: all var(--anim--hover-time) var(--anim--hover-ease);
      overflow: visible;
      opacity: 1;
    }

    /* ========== BUTTON BASE STYLES ========== */
    .button-wrap button {
      /* Basic Styling */
      --border-width: clamp(1px, 0.0625em, 4px);
      all: unset;
      cursor: pointer;
      position: relative;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      pointer-events: auto;
      z-index: 3;
      background: linear-gradient(
        -75deg,
        rgba(144, 238, 144, 0.8),
        rgba(152, 251, 152, 0.85),
        rgba(144, 238, 144, 0.8)
      );
      border-radius: 999vw;
      box-shadow: inset 0 0.125em 0.125em rgba(0, 0, 0, 0.1),
        inset 0 -0.125em 0.125em rgba(255, 255, 255, 0.3),
        0 0.25em 0.125em -0.125em rgba(0, 0, 0, 0.2),
        0 0 0.1em 0.25em inset rgba(255, 255, 255, 0.2),
        0 0 0 0 rgba(255, 255, 255, 1);
      backdrop-filter: blur(clamp(1px, 0.125em, 4px));
      -webkit-backdrop-filter: blur(clamp(1px, 0.125em, 4px));
      -moz-backdrop-filter: blur(clamp(1px, 0.125em, 4px));
      -ms-backdrop-filter: blur(clamp(1px, 0.125em, 4px));
      transition: all var(--anim--hover-time) var(--anim--hover-ease);
    }

    .button-wrap button:hover {
      transform: scale(0.975);
      backdrop-filter: blur(0.01em);
      -webkit-backdrop-filter: blur(0.01em);
      -moz-backdrop-filter: blur(0.01em);
      -ms-backdrop-filter: blur(0.01em);
      box-shadow: inset 0 0.125em 0.125em rgba(0, 0, 0, 0.1),
        inset 0 -0.125em 0.125em rgba(255, 255, 255, 0.4),
        0 0.15em 0.05em -0.1em rgba(0, 0, 0, 0.2),
        0 0 0.05em 0.1em inset rgba(255, 255, 255, 0.3),
        0 0 0 0 rgba(255, 255, 255, 1);
    }

    /* Button Text */
    .button-wrap button span {
      position: relative;
      display: block;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      font-family: "Inter", sans-serif;
      letter-spacing: -0.05em;
      font-weight: 500;
      font-size: 1.2em;
      color: rgba(255, 255, 255, 0.95);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-shadow: 0em 0.1em 0.05em rgba(0, 0, 0, 0.3);
      transition: all var(--anim--hover-time) var(--anim--hover-ease);
      padding-inline: 2em;
      padding-block: 1.2em;
    }

    .button-wrap button:hover span {
      color: rgba(255, 255, 255, 1);
      text-shadow: 0.025em 0.025em 0.025em rgba(0, 0, 0, 0.4);
    }

    /* Text */
    .button-wrap button span::after {
      content: "";
      display: block;
      position: absolute;
      z-index: 1;
      width: calc(100% - var(--border-width));
      height: calc(100% - var(--border-width));
      top: calc(0% + var(--border-width) / 2);
      left: calc(0% + var(--border-width) / 2);
      box-sizing: border-box;
      border-radius: 999vw;
      overflow: clip;
      background: linear-gradient(
        var(--angle-2),
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.5) 40% 50%,
        rgba(255, 255, 255, 0) 55%
      );
      z-index: 3;
      mix-blend-mode: screen;
      pointer-events: none;
      background-size: 200% 200%;
      background-position: 0% 50%;
      background-repeat: no-repeat;
      transition: background-position calc(var(--anim--hover-time) * 1.25)
          var(--anim--hover-ease),
        --angle-2 calc(var(--anim--hover-time) * 1.25) var(--anim--hover-ease);
    }

    .button-wrap button:hover span::after {
      background-position: 25% 50%;
    }

    .button-wrap button:active span::after {
      background-position: 50% 15%;
      --angle-2: -15deg;
    }

    /* ========== BUTTON OUTLINE ========== */
    .button-wrap button::after {
      content: "";
      position: absolute;
      z-index: 1;
      inset: 0;
      border-radius: 999vw;
      width: calc(100% + var(--border-width));
      height: calc(100% + var(--border-width));
      top: calc(0% - var(--border-width) / 2);
      left: calc(0% - var(--border-width) / 2);
      padding: var(--border-width);
      box-sizing: border-box;
      background: conic-gradient(
          from var(--angle-1) at 50% 50%,
          rgba(0, 0, 0, 0.5),
          rgba(0, 0, 0, 0) 5% 40%,
          rgba(0, 0, 0, 0.5) 50%,
          rgba(0, 0, 0, 0) 60% 95%,
          rgba(0, 0, 0, 0.5)
        ),
        linear-gradient(180deg, rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5));
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask-composite: exclude;
      transition: all var(--anim--hover-time) var(--anim--hover-ease),
        --angle-1 500ms ease;
      box-shadow: inset 0 0 0 calc(var(--border-width) / 2) rgba(255, 255, 255, 0.5);
    }

    .button-wrap button:hover::after {
      --angle-1: -125deg;
    }

    .button-wrap button:active::after {
      --angle-1: -75deg;
    }

    /* Shadow Hover */
    .button-wrap:has(button:hover) .button-shadow {
      filter: blur(clamp(2px, 0.0625em, 6px));
      -webkit-filter: blur(clamp(2px, 0.0625em, 6px));
      -moz-filter: blur(clamp(2px, 0.0625em, 6px));
      -ms-filter: blur(clamp(2px, 0.0625em, 6px));
      transition: filter var(--anim--hover-time) var(--anim--hover-ease);
    }

    .button-wrap:has(button:hover) .button-shadow::after {
      top: calc(var(--shadow-cuttoff-fix) - 0.875em);
      opacity: 1;
    }

    /* Rotation */
    .button-wrap:has(button:active) {
      transform: rotate3d(1, 0, 0, 25deg);
    }

    .button-wrap:has(button:active) button {
      box-shadow: inset 0 0.125em 0.125em rgba(0, 0, 0, 0.2),
        inset 0 -0.125em 0.125em rgba(255, 255, 255, 0.4),
        0 0.125em 0.125em -0.125em rgba(0, 0, 0, 0.2),
        0 0 0.1em 0.25em inset rgba(255, 255, 255, 0.3),
        0 0.225em 0.05em 0 rgba(0, 0, 0, 0.1),
        0 0.25em 0 0 rgba(255, 255, 255, 0.7),
        inset 0 0.25em 0.05em 0 rgba(0, 0, 0, 0.15);
    }

    .button-wrap:has(button:active) .button-shadow {
      filter: blur(clamp(2px, 0.125em, 12px));
      -webkit-filter: blur(clamp(2px, 0.125em, 12px));
      -moz-filter: blur(clamp(2px, 0.125em, 12px));
      -ms-filter: blur(clamp(2px, 0.125em, 12px));
    }

    .button-wrap:has(button:active) .button-shadow::after {
      top: calc(var(--shadow-cuttoff-fix) - 0.5em);
      opacity: 0.75;
    }

    .button-wrap:has(button:active) span {
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 0.025em 0.25em 0.05em rgba(0, 0, 0, 0.5);
    }

    /* Estilos para verificaci√≥n de errores */
    .glass-modal-verificacion {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .glass-modal-verificacion-content h3 {
      color: #ff6b6b;
      margin: 0 0 10px 0;
      font-size: 1.2em;
    }

    .glass-modal-verificacion-content p {
      color: rgba(255, 255, 255, 0.8);
      margin: 0 0 15px 0;
      line-height: 1.5;
    }

    /* Estilos para filas con errores */
    .item-error {
      background: rgba(255, 107, 107, 0.1) !important;
      border-left: 3px solid #ff6b6b !important;
    }

    .item-error td {
      color: #ff6b6b !important;
    }

    /* Estilos para error de sucursal */
    .sucursal-error {
      color: #ff6b6b !important;
      font-weight: bold;
    }

    .sucursal-error::after {
      content: " ‚ùå NO DETECTADA";
      color: #ff6b6b;
      font-size: 0.9em;
    }

    /* Estilos para campos editables */
    .campo-editable {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      padding: 4px 8px;
      color: white;
      font-size: 0.9em;
      min-width: 80px;
    }

    .campo-editable:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
    }

    .campo-editable.error {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }

    .campo-sucursal-editable {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      padding: 6px 12px;
      color: white;
      font-size: 1em;
      min-width: 200px;
    }

    .campo-sucursal-editable:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
    }

    .campo-sucursal-editable.error {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }


    .btn-flotante-sap      .hidden {
        display: none;
      }

      /* Estilos para checkboxes glassmorphism */
      .col-checkbox {
        width: 40px;
        text-align: center;
        padding: 4px 8px;
        min-width: 40px;
      }

      .glass-checkbox {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .glass-checkbox:hover {
        border-color: rgba(255, 255, 255, 0.5);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 0 2px rgba(255, 255, 255, 0.1);
      }

      .glass-checkbox:checked {
        background: linear-gradient(135deg, rgba(144, 238, 144, 0.8), rgba(152, 251, 152, 0.9));
        border-color: rgba(255, 255, 255, 0.6);
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 0 2px rgba(144, 238, 144, 0.3);
      }

      .glass-checkbox:checked::after {
        content: "‚úì";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: rgba(255, 255, 255, 0.95);
        font-size: 12px;
        font-weight: bold;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      .glass-checkbox:focus {
        outline: none;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 0 3px rgba(255, 255, 255, 0.2);
      }

      /* Mejorar organizaci√≥n de la tabla */
      .glass-table th.col-checkbox {
        padding: 8px 4px;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
      }

      .glass-table td.col-checkbox {
        padding: 8px 4px;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        vertical-align: middle;
      }

      /* Asegurar que las columnas tengan anchos apropiados */
      .glass-table th:nth-child(2) { /* # Pedido */
        width: 120px;
        min-width: 120px;
      }

      .glass-table th:nth-child(3) { /* Cliente */
        width: 150px;
        min-width: 150px;
      }

      .glass-table th:nth-child(4) { /* Sucursal */
        width: 120px;
        min-width: 120px;
      }

      .glass-table th:nth-child(5) { /* Fecha */
        width: 180px;
        min-width: 180px;
      }

      .glass-table th:nth-child(6) { /* Origen */
        width: 80px;
        min-width: 80px;
    }

    /* Estilos para las subpesta√±as activas */
    .main-header-link.is-active {
      background: rgba(102, 126, 234, 0.2);
      border-bottom: 2px solid #667eea;
    }

    /* Estilos para los contenedores de filtros */
    .filter-container {
      position: relative;
      margin-bottom: 8px;
      overflow: visible;
    }

    /* Estilos para las pastillas de filtros */
    .filter-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      justify-content: space-between;
    }

    .filter-chip:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .filter-chip.active {
      background: rgba(102, 126, 234, 0.3);
      border-color: #667eea;
    }

    .filter-label {
      color: var(--content-title-color);
      font-weight: 500;
    }

    .filter-value {
      color: var(--theme-color);
      font-weight: 400;
    }

    .filter-clear {
      color: var(--inactive-color);
      font-size: 1.2rem;
      font-weight: bold;
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }

    .filter-clear:hover {
      opacity: 1;
    }

    /* Estilos para los dropdowns peque√±os */
    .filter-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--theme-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: none;
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
    }

    .filter-dropdown.show {
      display: block;
    }

    /* Estilos para opciones de cliente */
    .cliente-option {
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cliente-option:last-child {
      border-bottom: none;
    }

    .cliente-option:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .cliente-option.selected {
      background: rgba(102, 126, 234, 0.2);
    }

    .cliente-nombre {
      color: var(--theme-color);
      font-weight: 500;
      font-size: 0.9rem;
    }

    /* Estilos para el calendario glassmorphism */
    .glass-calendar {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--theme-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      backdrop-filter: blur(20px) saturate(140%);
      -webkit-backdrop-filter: blur(20px) saturate(140%);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      margin-top: 2px;
      padding: 16px;
      display: none;
      min-width: 280px;
      overflow: visible;
    }

    .glass-calendar.show {
      display: block;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .calendar-nav {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: var(--theme-color);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
      font-weight: bold;
    }

    .calendar-nav:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .calendar-month-year {
      color: var(--theme-color);
      font-weight: 600;
      font-size: 1rem;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .weekday {
      text-align: center;
      color: var(--content-title-color);
      font-size: 0.8rem;
      font-weight: 500;
      padding: 8px 4px;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--theme-color);
      padding: 8px 4px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.85rem;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calendar-day:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .calendar-day.selected {
      background: rgba(102, 126, 234, 0.4);
      border-color: #667eea;
      color: white;
      font-weight: 600;
    }

    .calendar-day.other-month {
      color: var(--inactive-color);
      opacity: 0.5;
    }

    .calendar-day.today {
      background: rgba(102, 126, 234, 0.2);
      border-color: rgba(102, 126, 234, 0.5);
    }

    .calendar-day.today.selected {
      background: rgba(102, 126, 234, 0.6);
      border-color: #667eea;
    }
    </style>

    <script>
    (function(){
      const $$ = (sel, ctx=document) => ctx.querySelector(sel);
      const $$$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

      const overlay = $$("#modalOverlay");
      const modal   = $$("#modalDetalle");
      const btnX    = $$("#m-cerrar");
      const btnSAP  = $$("#btnSAP");
      const estadoActual = $$("#estado-actual");

      window.estadoSeleccionado = "{{ estado_actual or 'por_procesar' }}";

      const fmtMoney = (n) => (n===null || n===undefined) ? "-" : n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
      const fmtDate  = (iso) => {
        if(!iso) return "-";
        const d = new Date(iso);
        if(isNaN(d)) return iso;
        return d.toLocaleString();
      };

      function abrirModal(){ overlay.classList.remove("hidden"); modal.classList.remove("hidden"); }
      function cerrarModal(){ overlay.classList.add("hidden"); modal.classList.add("hidden"); }

      overlay.addEventListener("click", cerrarModal);
      btnX.addEventListener("click", cerrarModal);
      window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") cerrarModal(); });

      async function cargarDetalle(pedidoId){
        const resp = await fetch(`/api/pedidos/${pedidoId}`);
        if(!resp.ok) throw new Error("No se pudo obtener el detalle");
        return resp.json();
      }

      function renderDetalle(data){
        $$("#m-numero").textContent = data.numero_pedido ?? "";
        
        // Mostrar sucursal con indicador de error si es necesario
        const sucursalElement = $$("#m-sucursal");
        if (data.tiene_error_sucursal) {
          // Crear campo editable para sucursal
          const inputSucursal = document.createElement("input");
          inputSucursal.type = "text";
          inputSucursal.className = "campo-sucursal-editable error";
          inputSucursal.value = data.sucursal || "";
          inputSucursal.placeholder = "Ingrese la sucursal";
          inputSucursal.dataset.originalValue = data.sucursal || "";
          sucursalElement.innerHTML = "";
          sucursalElement.appendChild(inputSucursal);
        } else {
          sucursalElement.textContent = data.sucursal || "-";
          sucursalElement.classList.remove("sucursal-error");
        }
        
        $$("#m-fecha").textContent = fmtDate(data.fecha);

        const tb = $$("#m-items");
        tb.innerHTML = "";
        for(const it of (data.items || [])){
          const tr = document.createElement("tr");
          // Agregar clase de error si el producto tiene error
          if (it.tiene_error) {
            tr.classList.add("item-error");
          }
          
          // Crear celdas con campos editables si hay errores
          const tdSku = document.createElement("td");
          const tdDesc = document.createElement("td");
          const tdCant = document.createElement("td");
          
          if (it.tiene_error) {
            // SKU editable
            const inputSku = document.createElement("input");
            inputSku.type = "text";
            inputSku.className = "campo-editable error";
            inputSku.value = it.sku || "";
            inputSku.placeholder = "Ingrese SKU";
            inputSku.dataset.originalValue = it.sku || "";
            tdSku.appendChild(inputSku);
            
            // Descripci√≥n (solo lectura)
            tdDesc.textContent = (it.descripcion || "").replace(/</g,"&lt;");
            
            // Cantidad editable
            const inputCant = document.createElement("input");
            inputCant.type = "number";
            inputCant.className = "campo-editable error";
            inputCant.value = it.cantidad || "";
            inputCant.min = "1";
            inputCant.placeholder = "Cantidad";
            inputCant.dataset.originalValue = it.cantidad || "";
            tdCant.appendChild(inputCant);
          } else {
            // Campos normales (solo lectura)
            tdSku.textContent = it.sku || "";
            tdSku.className = "mono";
            tdDesc.textContent = (it.descripcion || "").replace(/</g,"&lt;");
            tdCant.textContent = it.cantidad ?? "";
            tdCant.className = "num mono";
          }
          
          tr.appendChild(tdSku);
          tr.appendChild(tdDesc);
          tr.appendChild(tdCant);
          tb.appendChild(tr);
        }

        // Mostrar recuadro de verificaci√≥n si hay errores
        const tieneErroresProductos = data.items && data.items.some(item => item.tiene_error);
        const tieneErrorSucursal = data.tiene_error_sucursal;
        const tieneErrores = tieneErroresProductos || tieneErrorSucursal;
        
        const verificacionContainer = $$("#verificacion-container");
        if (tieneErrores) {
          verificacionContainer.style.display = "block";
          
          // Actualizar mensaje seg√∫n el tipo de error
          const mensajeElement = verificacionContainer.querySelector("p");
          if (tieneErrorSucursal && tieneErroresProductos) {
            mensajeElement.textContent = "Este pedido contiene productos que no pudieron ser emparejados correctamente y no se detect√≥ una sucursal v√°lida. Por favor, verifica y corrige los errores antes de procesar.";
          } else if (tieneErrorSucursal) {
            mensajeElement.textContent = "Este pedido no tiene una sucursal v√°lida detectada. Por favor, verifica y corrige este error antes de procesar.";
          } else {
            mensajeElement.textContent = "Este pedido contiene productos que no pudieron ser emparejados correctamente. Por favor, verifica y corrige los errores antes de procesar.";
          }
        } else {
          verificacionContainer.style.display = "none";
        }

      }

      // Funci√≥n para verificar y actualizar pedido
      window.verificarPedido = async function() {
        const pedidoId = window.pedidoActualId;
        if (!pedidoId) {
          alert("Error: No se pudo identificar el pedido");
          return;
        }

        // Recopilar datos editados
        const datosActualizados = {
          sucursal: null,
          items: []
        };

        // Obtener sucursal editada solo si hay error de sucursal
        const inputSucursal = document.querySelector("#m-sucursal .campo-sucursal-editable");
        if (inputSucursal) {
          datosActualizados.sucursal = inputSucursal.value.trim();
        } else {
          // Si no hay campo editable, obtener la sucursal actual del texto
          const sucursalElement = document.querySelector("#m-sucursal");
          if (sucursalElement) {
            datosActualizados.sucursal = sucursalElement.textContent.trim();
          }
        }

        // Obtener items editados
        const filas = document.querySelectorAll("#m-items tr");
        filas.forEach((fila, index) => {
          const inputSku = fila.querySelector(".campo-editable[type='text']");
          const inputCant = fila.querySelector(".campo-editable[type='number']");
          
          if (inputSku && inputCant) {
            datosActualizados.items.push({
              index: index,
              sku: inputSku.value.trim(),
              cantidad: parseInt(inputCant.value) || 0
            });
          }
        });

        // Validar datos
        const errores = [];
        
        // Validar sucursal solo si hay error de sucursal
        // Usar la variable inputSucursal ya declarada arriba
        const tieneErrorSucursal = inputSucursal !== null;
        
        if (tieneErrorSucursal && !datosActualizados.sucursal) {
          errores.push("‚ùå La sucursal es requerida. Por favor, ingrese el nombre de la sucursal.");
        }

        // Validar items
        datosActualizados.items.forEach((item, index) => {
          if (!item.sku) {
            errores.push(`‚ùå Producto ${index + 1}: El SKU es requerido. Por favor, ingrese el SKU del producto.`);
          }
          if (item.cantidad <= 0) {
            errores.push(`‚ùå Producto ${index + 1}: La cantidad debe ser mayor a 0. Por favor, ingrese una cantidad v√°lida.`);
          }
        });

        if (errores.length > 0) {
          alert("‚ùå Errores encontrados:\n\n" + errores.join("\n\n"));
          return;
        }

        // Mostrar indicador de carga
        const btnVerificar = document.getElementById("btn-verificar");
        const textoOriginal = btnVerificar.innerHTML;
        btnVerificar.innerHTML = '<i class="icon">‚è≥</i> Verificando...';
        btnVerificar.disabled = true;

        try {
          // Enviar datos al servidor
          const response = await fetch(`/api/pedidos/${pedidoId}/verificar`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(datosActualizados)
          });

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          const resultado = await response.json();
          
          if (resultado.exito) {
            alert("‚úÖ Pedido verificado exitosamente. El estado ha cambiado a 'Por procesar'.");
            // Cerrar modal y recargar lista
            cerrarModal();
            window.cargarPedidosPorEstado("con_errores");
          } else {
            alert("‚ùå Error al verificar el pedido: " + (resultado.error || "Error desconocido"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("‚ùå Error al verificar el pedido: " + error.message);
        } finally {
          // Restaurar bot√≥n
          btnVerificar.innerHTML = textoOriginal;
          btnVerificar.disabled = false;
        }
      }

      // Variables globales para filtros
      window.filtrosActuales = {
        cliente_id: null,
        fecha_desde: null,
        fecha_hasta: null
      };

      // Funci√≥n para cargar pedidos por estado con filtros
      window.cargarPedidosPorEstado = async function(estado) {
        try {
          // Construir URL con filtros
          const params = new URLSearchParams();
          if (window.filtrosActuales.cliente_id) {
            params.append('cliente_id', window.filtrosActuales.cliente_id);
          }
          if (window.filtrosActuales.fecha_desde) {
            params.append('fecha_desde', window.filtrosActuales.fecha_desde);
          }
          if (window.filtrosActuales.fecha_hasta) {
            params.append('fecha_hasta', window.filtrosActuales.fecha_hasta);
          }
          
          const url = `/api/pedidos/por_estado/${estado}${params.toString() ? '?' + params.toString() : ''}`;
          const resp = await fetch(url);
          if (!resp.ok) throw new Error("Error al cargar pedidos");
          const data = await resp.json();
          
          const tbody = $$("#ordersTableBody");
          tbody.innerHTML = "";
          
          for (const pedido of data.pedidos) {
            const tr = document.createElement("tr");
            tr.className = "row-pedido";
            tr.setAttribute("data-pedido-id", pedido.id);
            tr.setAttribute("role", "button");
            tr.setAttribute("tabindex", "0");
            tr.setAttribute("title", "Ver detalle");
            
            tr.innerHTML = `
                <td class="col-checkbox" data-label="Seleccionar">
                  <input type="checkbox" class="glass-checkbox pedido-checkbox" data-pedido-id="${pedido.id}">
                </td>
              <td class="mono" data-label="# Pedido">${pedido.numero_pedido}</td>
                <td data-label="Cliente">${pedido.cliente_nombre || 'Roldan'}</td>
              <td data-label="Sucursal">${pedido.sucursal || '-'}</td>
              <td data-label="Fecha">${pedido.fecha ? new Date(pedido.fecha).toLocaleString() : ''}</td>
              <td data-label="Origen">Email</td>
            `;
            
            // Agregar event listeners para el modal
            tr.addEventListener("click", async (e)=>{
              // No abrir modal si se hace clic en el checkbox
              if (e.target.classList.contains('glass-checkbox')) {
                return;
              }
              try{
                window.pedidoActualId = pedido.id; // Guardar ID del pedido
                const data = await cargarDetalle(pedido.id);
                renderDetalle(data);
                abrirModal();
              }catch(e){
                console.error(e);
                alert("No se pudo cargar el detalle del pedido.");
              }
            });
            tr.addEventListener("keydown", (e)=>{
              if(e.key==="Enter" || e.key===" "){ 
                e.preventDefault(); 
                window.pedidoActualId = pedido.id; // Guardar ID del pedido
                tr.click(); 
              }
            });
            
            tbody.appendChild(tr);
          }
          
          estadoActual.textContent = estado;
          window.estadoSeleccionado = estado;
          
          // Mostrar/ocultar bot√≥n SAP
          if (estado === "por_procesar") {
            btnSAP.classList.remove("hidden");
          } else {
            btnSAP.classList.add("hidden");
          }
          
          // Reiniciar checkboxes
          reiniciarCheckboxes();
          
        } catch (error) {
          console.error("Error:", error);
          alert("Error al cargar los pedidos");
        }
      }

      // Funci√≥n para reiniciar checkboxes
      function reiniciarCheckboxes() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const pedidoCheckboxes = document.querySelectorAll('.pedido-checkbox');
        
        // Desmarcar todos los checkboxes
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        pedidoCheckboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
        
        // Remover event listeners existentes para evitar duplicados
        const newSelectAllCheckbox = selectAllCheckbox.cloneNode(true);
        selectAllCheckbox.parentNode.replaceChild(newSelectAllCheckbox, selectAllCheckbox);
        
        // Agregar event listener al nuevo checkbox
        newSelectAllCheckbox.addEventListener('change', function() {
          const currentPedidoCheckboxes = document.querySelectorAll('.pedido-checkbox');
          currentPedidoCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
          });
        });
      }

      // Event listener global para checkboxes individuales (solo se agrega una vez)
      if (!window.checkboxListenerAdded) {
        document.addEventListener('change', function(e) {
          if (e.target.classList.contains('pedido-checkbox')) {
            const totalCheckboxes = document.querySelectorAll('.pedido-checkbox').length;
            const checkedCheckboxes = document.querySelectorAll('.pedido-checkbox:checked').length;
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (selectAllCheckbox) {
              // Actualizar checkbox "Seleccionar todo"
              selectAllCheckbox.checked = checkedCheckboxes === totalCheckboxes;
              selectAllCheckbox.indeterminate = checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes;
            }
          }
        });
        window.checkboxListenerAdded = true;
      }

      // Event listeners para las subpesta√±as
      $$$(".main-header-link").forEach(link => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const estado = link.getAttribute("data-estado");
          
          // Actualizar estado activo
          $$$(".main-header-link").forEach(l => l.classList.remove("is-active"));
          link.classList.add("is-active");
          
          // Cargar pedidos del estado seleccionado
          window.cargarPedidosPorEstado(estado);
        });
      });

      // Event listener para el bot√≥n SAP
      btnSAP.addEventListener("click", async () => {
        // Verificar si hay pedidos seleccionados
        const pedidosSeleccionados = document.querySelectorAll('.pedido-checkbox:checked');
        
        if (pedidosSeleccionados.length === 0) {
          alert("No hay pedidos seleccionados para exportar. Por favor, selecciona al menos un pedido.");
          return;
        }
        
        const idsSeleccionados = Array.from(pedidosSeleccionados).map(checkbox => checkbox.dataset.pedidoId);
        
        if (!confirm(`¬øGenerar archivos SAP para ${idsSeleccionados.length} pedido(s) seleccionado(s)?`)) {
          return;
        }
        
        const button = btnSAP.querySelector("button");
        const span = btnSAP.querySelector("span");
        button.disabled = true;
        span.textContent = "Generando...";
        
        try {
          const resp = await fetch("/api/generar_sap", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              pedidos_ids: idsSeleccionados
            })
          });
          
          const data = await resp.json();
          
          if (data.ok) {
            alert(`‚úÖ ${data.mensaje}\n\nArchivos generados:\n- ${data.archivos.odrf}\n- ${data.archivos.drf1}`);
            // Recargar pedidos por procesar
            window.cargarPedidosPorEstado("por_procesar");
          } else {
            alert(`‚ùå ${data.mensaje || data.error}`);
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error al generar archivos SAP");
        } finally {
          button.disabled = false;
          span.textContent = "SAP";
        }
      });

      // Inicializar con el estado actual
      const linkActivo = $$(`[data-estado="${window.estadoSeleccionado}"]`);
      if (linkActivo) {
        linkActivo.classList.add("is-active");
      }
      
      // Mostrar/ocultar bot√≥n SAP seg√∫n estado inicial
      if (window.estadoSeleccionado === "por_procesar") {
        btnSAP.classList.remove("hidden");
      }
    })();
    </script>

    <script>
    // Sistema de filtros con dropdowns
    (function(){
      const $$ = (sel, ctx=document) => ctx.querySelector(sel);
      const $$$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

      // Elementos del DOM
      const filterCliente = $$("#filter-cliente");
      const filterDesde = $$("#filter-desde");
      const filterHasta = $$("#filter-hasta");
      
      const dropdownCliente = $$("#dropdown-cliente");
      
      const clientesContainer = $$("#clientes-container");
      const calendarDesde = $$("#calendar-desde");
      const calendarHasta = $$("#calendar-hasta");

      // Variables globales
      let clientesLista = [];
      let clienteSeleccionado = null;
      let fechaDesdeSeleccionada = null;
      let fechaHastaSeleccionada = null;

      // Variables para calendarios
      let currentMonthDesde = new Date();
      let currentMonthHasta = new Date();
      let selectedDateDesde = null;
      let selectedDateHasta = null;

      // Funci√≥n para mostrar calendario
      function mostrarCalendario(calendar) {
        calendar.classList.add("show");
        if (calendar === calendarDesde) {
          renderCalendar(calendarDesde, currentMonthDesde, selectedDateDesde);
        } else {
          renderCalendar(calendarHasta, currentMonthHasta, selectedDateHasta);
        }
      }

      // Funci√≥n para renderizar calendario
      function renderCalendar(calendar, currentMonth, selectedDate) {
        const monthYear = calendar.querySelector('.calendar-month-year');
        const daysContainer = calendar.querySelector('.calendar-days');
        
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        
        monthYear.textContent = currentMonth.toLocaleDateString('es-ES', { 
          month: 'long', 
          year: 'numeric' 
        });
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay() + 1); // Lunes
        
        daysContainer.innerHTML = '';
        
        for (let i = 0; i < 42; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          
          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day';
          dayElement.textContent = date.getDate();
          
          // Marcar d√≠as de otros meses
          if (date.getMonth() !== month) {
            dayElement.classList.add('other-month');
          }
          
          // Marcar d√≠a actual
          const today = new Date();
          if (date.toDateString() === today.toDateString()) {
            dayElement.classList.add('today');
          }
          
          // Marcar d√≠a seleccionado
          if (selectedDate && date.toDateString() === selectedDate.toDateString()) {
            dayElement.classList.add('selected');
          }
          
          dayElement.addEventListener('click', () => {
            selectDate(calendar, date);
          });
          
          daysContainer.appendChild(dayElement);
        }
      }

      // Funci√≥n para seleccionar fecha
      function selectDate(calendar, date) {
        if (calendar === calendarDesde) {
          selectedDateDesde = date;
          fechaDesdeSeleccionada = date.toISOString().split('T')[0];
        } else {
          selectedDateHasta = date;
          fechaHastaSeleccionada = date.toISOString().split('T')[0];
        }
        
        actualizarVisualizacionFiltros();
        aplicarFiltros();
        cerrarTodosLosDropdowns();
      }

      // Funci√≥n para cerrar todos los dropdowns
      function cerrarTodosLosDropdowns() {
        $$$(".filter-dropdown").forEach(dropdown => {
          dropdown.classList.remove("show");
        });
        
        // Ocultar calendarios
        calendarDesde.classList.remove("show");
        calendarHasta.classList.remove("show");
      }

      // Funci√≥n para actualizar la visualizaci√≥n de filtros
      function actualizarVisualizacionFiltros() {
        // Actualizar pastilla de cliente
        const clienteValue = $$("#filter-cliente .filter-value");
        if (clienteSeleccionado) {
          clienteValue.textContent = clienteSeleccionado.nombre;
          filterCliente.classList.add("active");
        } else {
          clienteValue.textContent = "Todos";
          filterCliente.classList.remove("active");
        }

        // Actualizar pastilla de fecha desde
        const desdeValue = $$("#filter-desde .filter-value");
        if (fechaDesdeSeleccionada) {
          // Crear fecha local para evitar problemas de zona horaria
          const fechaLocal = new Date(fechaDesdeSeleccionada + 'T00:00:00');
          desdeValue.textContent = fechaLocal.toLocaleDateString();
          filterDesde.classList.add("active");
        } else {
          desdeValue.textContent = "Todos";
          filterDesde.classList.remove("active");
        }

        // Actualizar pastilla de fecha hasta
        const hastaValue = $$("#filter-hasta .filter-value");
        if (fechaHastaSeleccionada) {
          // Crear fecha local para evitar problemas de zona horaria
          const fechaLocal = new Date(fechaHastaSeleccionada + 'T00:00:00');
          hastaValue.textContent = fechaLocal.toLocaleDateString();
          filterHasta.classList.add("active");
        } else {
          hastaValue.textContent = "Todos";
          filterHasta.classList.remove("active");
        }
      }

      // Funci√≥n para aplicar filtros
      function aplicarFiltros() {
        // Actualizar filtros globales
        window.filtrosActuales = {
          cliente_id: clienteSeleccionado ? clienteSeleccionado.id : null,
          fecha_desde: fechaDesdeSeleccionada,
          fecha_hasta: fechaHastaSeleccionada
        };

        // Recargar pedidos del estado actual
        if (window.cargarPedidosPorEstado) {
          window.cargarPedidosPorEstado(window.estadoSeleccionado || "por_procesar");
        }
      }

      // Funci√≥n para cargar clientes
      async function cargarClientes() {
        try {
          const resp = await fetch("/api/clientes");
          if (!resp.ok) throw new Error("Error al cargar clientes");
          const data = await resp.json();
          clientesLista = data.clientes;
          
          // Renderizar lista de clientes
          clientesContainer.innerHTML = "";
          clientesLista.forEach(cliente => {
            const div = document.createElement("div");
            div.className = "cliente-option";
            div.setAttribute("data-cliente-id", cliente.id);
            div.innerHTML = `<span class="cliente-nombre">${cliente.nombre}</span>`;
            clientesContainer.appendChild(div);
          });
        } catch (error) {
          console.error("Error al cargar clientes:", error);
        }
      }

      // Event listeners para pastillas de filtros
      filterCliente.addEventListener("click", (e) => {
        e.stopPropagation();
        cerrarTodosLosDropdowns();
        dropdownCliente.classList.toggle("show");
      });

      filterDesde.addEventListener("click", (e) => {
        e.stopPropagation();
        cerrarTodosLosDropdowns();
        mostrarCalendario(calendarDesde);
      });

      filterHasta.addEventListener("click", (e) => {
        e.stopPropagation();
        cerrarTodosLosDropdowns();
        mostrarCalendario(calendarHasta);
      });

      // Event listener para cerrar dropdowns al hacer clic fuera
      document.addEventListener("click", () => {
        cerrarTodosLosDropdowns();
      });

      // Event listeners para selecci√≥n de cliente
      dropdownCliente.addEventListener("click", (e) => {
        const clienteOption = e.target.closest(".cliente-option");
        if (clienteOption) {
          const clienteId = parseInt(clienteOption.getAttribute("data-cliente-id"));
          
          // Actualizar selecci√≥n visual
          $$$(".cliente-option").forEach(opt => opt.classList.remove("selected"));
          clienteOption.classList.add("selected");
          
          // Guardar selecci√≥n
          if (clienteId === 0) {
            clienteSeleccionado = null;
          } else {
            clienteSeleccionado = clientesLista.find(c => c.id === clienteId);
          }
          
          // Aplicar filtros y cerrar dropdown
          actualizarVisualizacionFiltros();
          aplicarFiltros();
          cerrarTodosLosDropdowns();
        }
      });

      // Event listeners para fechas removidos - ahora usamos calendario personalizado

      // Event listeners para botones de limpiar en las pastillas
      document.addEventListener("click", function(e) {
        if (e.target && e.target.classList && e.target.classList.contains("filter-clear")) {
          e.preventDefault();
          e.stopPropagation();
          
          console.log("‚úì Click en bot√≥n filter-clear detectado");
          
          // Determinar qu√© filtro limpiar basado en el contenedor padre
          const filterContainer = e.target.closest(".filter-container");
          if (!filterContainer) return;
          
          const filterChip = filterContainer.querySelector(".filter-chip");
          if (!filterChip) return;
          
          const filterId = filterChip.id;
          console.log("‚úì Limpiando filtro:", filterId);
          
          if (filterId === "filter-cliente") {
            clienteSeleccionado = null;
          } else if (filterId === "filter-desde") {
            fechaDesdeSeleccionada = null;
            selectedDateDesde = null;
          } else if (filterId === "filter-hasta") {
            fechaHastaSeleccionada = null;
            selectedDateHasta = null;
          }
          
          actualizarVisualizacionFiltros();
          aplicarFiltros();
          console.log("‚úì Filtro limpiado exitosamente");
        }
      });

      // Event listeners para navegaci√≥n del calendario
      $$("#prev-desde").addEventListener("click", (e) => {
        e.stopPropagation();
        currentMonthDesde.setMonth(currentMonthDesde.getMonth() - 1);
        renderCalendar(calendarDesde, currentMonthDesde, selectedDateDesde);
      });

      $$("#next-desde").addEventListener("click", (e) => {
        e.stopPropagation();
        currentMonthDesde.setMonth(currentMonthDesde.getMonth() + 1);
        renderCalendar(calendarDesde, currentMonthDesde, selectedDateDesde);
      });

      $$("#prev-hasta").addEventListener("click", (e) => {
        e.stopPropagation();
        currentMonthHasta.setMonth(currentMonthHasta.getMonth() - 1);
        renderCalendar(calendarHasta, currentMonthHasta, selectedDateHasta);
      });

      $$("#next-hasta").addEventListener("click", (e) => {
        e.stopPropagation();
        currentMonthHasta.setMonth(currentMonthHasta.getMonth() + 1);
        renderCalendar(calendarHasta, currentMonthHasta, selectedDateHasta);
      });

      // Inicializar
      cargarClientes();
      actualizarVisualizacionFiltros();
    })();
    </script>

    <script>
    // Configuraci√≥n de n√∫mero de pedido inicial
    (function(){
      const numeroPedidoInicial = document.getElementById("numeroPedidoInicial");
      const btnGuardarNumero = document.getElementById("btnGuardarNumero");

      // Cargar n√∫mero de pedido inicial al inicializar
      async function cargarNumeroPedidoInicial() {
          try {
              const response = await fetch('/api/configuracion/numero-pedido-inicial');
              if (response.ok) {
                  const data = await response.json();
                  numeroPedidoInicial.value = data.numero_inicial || '';
              }
          } catch (error) {
              console.error('Error al cargar n√∫mero de pedido inicial:', error);
          }
      }

      // Guardar n√∫mero de pedido inicial
      async function guardarNumeroPedidoInicial() {
          const numero = numeroPedidoInicial.value;
          
          if (!numero || numero < 1) {
              alert('‚ùå Error: N√∫mero de pedido inv√°lido.\n\nPor favor, ingrese un n√∫mero mayor a 0 para el pedido inicial.');
              return;
          }

          try {
              const response = await fetch('/api/configuracion/numero-pedido-inicial', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ numero_inicial: parseInt(numero) })
              });

              if (response.ok) {
                  alert(`‚úÖ N√∫mero de pedido inicial guardado: ${numero}`);
              } else {
                  const error = await response.json();
                  alert(`‚ùå Error: ${error.error}`);
              }
          } catch (error) {
              console.error('Error al guardar n√∫mero de pedido inicial:', error);
              alert('‚ùå Error al guardar la configuraci√≥n');
          }
      }

      // Event listeners
      btnGuardarNumero.addEventListener("click", guardarNumeroPedidoInicial);
      
      // Permitir guardar con Enter
      numeroPedidoInicial.addEventListener("keypress", (e) => {
          if (e.key === 'Enter') {
              guardarNumeroPedidoInicial();
          }
      });

      // Cargar configuraci√≥n al inicializar
      cargarNumeroPedidoInicial();
    })();
    </script>

    <script>
    // B√∫squeda r√°pida en la tabla
    (function(){
      const input = document.getElementById('quickSearch');
      const rows = () => Array.from(document.querySelectorAll('#ordersTable tbody tr'));
      function normalize(s){ return (s||'').toString().toLowerCase(); }
      input.addEventListener('input', ()=>{
        const q = normalize(input.value);
        rows().forEach(tr => {
          const text = normalize(tr.innerText);
          tr.style.display = text.includes(q) ? '' : 'none';
        });
      });
    })();
  </script>
  </body>
</html>