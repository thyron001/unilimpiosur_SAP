<!-- =============================
Pedidos Dashboard ‚Äî Glassmorphism (oscuro fijo)
Secci√≥n 1: HTML (templates/pedidos.html)
Secci√≥n 2: CSS  (static/css/glass.css)
============================= -->

<!-- ======= Secci√≥n 1: templates/pedidos.html ======= -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pedidos ‚Äî SAP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet">
    <link rel="stylesheet"
      href="{{ url_for('static', filename='css/glass.css') }}">
  </head>
  <body>
    <div class="app">
      <!-- Header superior (sin menu-circle, sin profile, sin toggle de tema) -->
      <div class="header">
        <nav class="header-menu" aria-label="Secciones">
          <a class="menu-link is-active" href="#">Pedidos</a>
          <a class="menu-link" href="/clientes">Clientes</a>
          <a class="menu-link" href="/productos">Productos</a>
          <a class="menu-link" href="#">Reportes</a>
        </nav>
        <div class="search-bar">
          <input type="text" id="quickSearch" placeholder="Buscar en pedidos‚Ä¶">
        </div>
      </div>

      <div class="wrapper">
        <!-- Sidebar izquierda -->
        <aside class="left-side">
          <section class="side-wrapper">
            <h3 class="side-title">Vistas</h3>
            <nav class="side-menu">
              <a href="#">üì• Todos los pedidos</a>
              <a href="#">‚ö° Recientes</a>
              <a href="#">‚≠ê Destacados</a>
            </nav>
          </section>
          <section class="side-wrapper">
            <h3 class="side-title">Filtros</h3>
            <div class="side-menu">
              <div class="filter-container">
                <div class="filter-chip" id="filter-cliente" data-filter="cliente">
                  <span class="filter-label">Cliente:</span>
                  <span class="filter-value">Todos</span>
                  <span class="filter-clear">√ó</span>
                </div>
                <div class="filter-dropdown" id="dropdown-cliente">
                  <div class="cliente-option" data-cliente-id="0">
                    <span class="cliente-nombre">Todos los clientes</span>
                  </div>
                  <div id="clientes-container"></div>
                </div>
              </div>
              
              <div class="filter-container">
                <div class="filter-chip" id="filter-desde" data-filter="desde">
                  <span class="filter-label">Desde:</span>
                  <span class="filter-value">Todos</span>
                  <span class="filter-clear">√ó</span>
                </div>
                <div class="filter-dropdown" id="dropdown-desde">
                  <input type="date" id="fecha-desde-input" class="fecha-input">
                  <div class="fecha-actions">
                    <button id="btn-limpiar-desde" class="btn-fecha-limpiar">Limpiar</button>
                    <button id="btn-aplicar-desde" class="btn-fecha-aplicar">Aplicar</button>
                  </div>
                </div>
              </div>
              
              <div class="filter-container">
                <div class="filter-chip" id="filter-hasta" data-filter="hasta">
                  <span class="filter-label">Hasta:</span>
                  <span class="filter-value">Todos</span>
                  <span class="filter-clear">√ó</span>
                </div>
                <div class="filter-dropdown" id="dropdown-hasta">
                  <input type="date" id="fecha-hasta-input" class="fecha-input">
                  <div class="fecha-actions">
                    <button id="btn-limpiar-hasta" class="btn-fecha-limpiar">Limpiar</button>
                    <button id="btn-aplicar-hasta" class="btn-fecha-aplicar">Aplicar</button>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section class="side-wrapper">
            <h3 class="side-title">Configuraci√≥n</h3>
            <div class="side-menu">
              <div class="config-item">
                <label for="numeroPedidoInicial" class="config-label">
                  üìã N√∫mero de pedido inicial
                </label>
                <input type="number" id="numeroPedidoInicial" 
                       class="config-input" 
                       placeholder="Ej: 10000"
                       min="1">
                <button id="btnGuardarNumero" class="chip" 
                        title="Guardar n√∫mero de pedido inicial">
                  üíæ Guardar
                </button>
              </div>
            </div>
          </section>
        </aside>

        <!-- Contenido principal -->
        <div class="main-container">
          <div class="main-header">
            <a class="menu-link main-header-link" href="#" data-estado="por_procesar">Por procesar</a>
            <a class="menu-link main-header-link" href="#" data-estado="procesado">Procesado</a>
            <a class="menu-link main-header-link" href="#" data-estado="con_errores">Con errores</a>
          </div>

          <div class="content-wrapper">
            <!-- (Se removi√≥ el content-wrapper-header / hero) -->

            <!-- Secci√≥n de la tabla -->
            <section class="content-section" id="pedidos">
              <h4 class="content-section-title">Listado</h4>
              <div class="card">
                <div class="card-head">
                  <div style="display:flex; align-items:center; gap:10px;">
                    <strong>Pedidos</strong>
                    <span id="estado-actual" class="chip">{{ estado_actual or 'por_procesar' }}</span>
                  </div>
                </div>
                <div class="table-wrap">
                  <table id="ordersTable" class="glass-table">
                    <thead>
                      <tr>
                        <th># Pedido</th>
                        <th>Cliente</th>
                        <th>Sucursal</th>
                        <th>Fecha</th>
                        <th>Origen</th>
                      </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                      {% for o in orders %}
                      <tr class="row-pedido" data-pedido-id="{{ o.id }}" role="button" tabindex="0" title="Ver detalle">
                        <td class="mono" data-label="# Pedido">{{ o.numero_pedido }}</td>
                        <td data-label="Cliente">Roldan</td>
                        <td data-label="Sucursal">{{ o.sucursal or '-' }}</td>
                        <td data-label="Fecha">{{ o.fecha.strftime('%Y-%m-%d %H:%M:%S') if o.fecha else '' }}</td>
                        <td data-label="Origen">Email</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- Bot√≥n flotante SAP (solo visible en "Por procesar") -->
            <button id="btnSAP" class="btn-flotante-sap hidden" title="Generar archivos SAP">
              <span>SAP</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Overlay + Modal Detalle Pedido -->
    <div id="modalOverlay" class="glass-overlay hidden"></div>

    <div id="modalDetalle" class="glass-modal hidden" role="dialog"
      aria-modal="true" aria-labelledby="modalTitle">
      <div class="glass-modal-card">
        <div class="glass-modal-head">
          <h3 id="modalTitle" class="mono">Pedido <span
              id="m-numero"></span></h3>
          <button id="m-cerrar" class="btn-close" aria-label="Cerrar">‚úï</button>
        </div>

        <div class="glass-modal-sub">
          <div><strong>Sucursal:</strong> <span id="m-sucursal">-</span></div>
          <div><strong>Fecha:</strong> <span id="m-fecha">-</span></div>
        </div>

        <div class="glass-modal-body">
          <div class="table-wrap">
            <table class="glass-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Descripci√≥n</th>
                  <th class="num">Cant.</th>
                </tr>
              </thead>
              <tbody id="m-items"></tbody>
            </table>
          </div>
        </div>

        <!-- Recuadro de verificaci√≥n para pedidos con errores -->
        <div id="verificacion-container" class="glass-modal-verificacion" style="display: none;">
          <div class="glass-modal-verificacion-content">
            <h3>Verificaci√≥n de Errores</h3>
            <p>Este pedido contiene errores que requieren verificaci√≥n. Por favor, revisa y corrige los problemas antes de procesar.</p>
            <button id="btn-verificar" class="glass-btn glass-btn-primary" onclick="window.verificarPedido()">
              <i class="icon">‚úì</i>
              Verificar
            </button>
          </div>
        </div>

      </div>
    </div>


    <style>
    /* Estilos para configuraci√≥n */
    .config-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .config-label {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 4px;
    }
    
    .config-input {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 0.9rem;
        transition: border-color 0.2s ease;
    }
    
    .config-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px rgba(159, 213, 255, 0.2);
    }
    
    /* Estilos para el bot√≥n flotante SAP */
    .btn-flotante-sap {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Estilos para verificaci√≥n de errores */
    .glass-modal-verificacion {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .glass-modal-verificacion-content h3 {
      color: #ff6b6b;
      margin: 0 0 10px 0;
      font-size: 1.2em;
    }

    .glass-modal-verificacion-content p {
      color: rgba(255, 255, 255, 0.8);
      margin: 0 0 15px 0;
      line-height: 1.5;
    }

    /* Estilos para filas con errores */
    .item-error {
      background: rgba(255, 107, 107, 0.1) !important;
      border-left: 3px solid #ff6b6b !important;
    }

    .item-error td {
      color: #ff6b6b !important;
    }

    /* Estilos para error de sucursal */
    .sucursal-error {
      color: #ff6b6b !important;
      font-weight: bold;
    }

    .sucursal-error::after {
      content: " ‚ùå NO DETECTADA";
      color: #ff6b6b;
      font-size: 0.9em;
    }

    /* Estilos para campos editables */
    .campo-editable {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      padding: 4px 8px;
      color: white;
      font-size: 0.9em;
      min-width: 80px;
    }

    .campo-editable:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
    }

    .campo-editable.error {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }

    .campo-sucursal-editable {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      padding: 6px 12px;
      color: white;
      font-size: 1em;
      min-width: 200px;
    }

    .campo-sucursal-editable:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
    }

    .campo-sucursal-editable.error {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }

    .btn-flotante-sap:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
    }

    .btn-flotante-sap:active {
      transform: translateY(-1px);
    }

    .btn-flotante-sap.hidden {
      display: none;
    }

    /* Estilos para las subpesta√±as activas */
    .main-header-link.is-active {
      background: rgba(102, 126, 234, 0.2);
      border-bottom: 2px solid #667eea;
    }

    /* Estilos para los contenedores de filtros */
    .filter-container {
      position: relative;
      margin-bottom: 8px;
    }

    /* Estilos para las pastillas de filtros */
    .filter-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .filter-chip:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .filter-chip.active {
      background: rgba(102, 126, 234, 0.3);
      border-color: #667eea;
    }

    .filter-label {
      color: var(--content-title-color);
      font-weight: 500;
    }

    .filter-value {
      color: var(--theme-color);
      font-weight: 400;
    }

    .filter-clear {
      color: var(--inactive-color);
      font-size: 1.2rem;
      font-weight: bold;
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }

    .filter-clear:hover {
      opacity: 1;
    }

    /* Estilos para los dropdowns peque√±os */
    .filter-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--theme-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: none;
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
    }

    .filter-dropdown.show {
      display: block;
    }

    /* Estilos para opciones de cliente */
    .cliente-option {
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cliente-option:last-child {
      border-bottom: none;
    }

    .cliente-option:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .cliente-option.selected {
      background: rgba(102, 126, 234, 0.2);
    }

    .cliente-nombre {
      color: var(--theme-color);
      font-weight: 500;
      font-size: 0.9rem;
    }

    /* Estilos para inputs de fecha */
    .fecha-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--theme-bg-color);
      color: var(--theme-color);
      font-size: 0.9rem;
      transition: border-color 0.2s ease;
      margin-bottom: 8px;
    }

    .fecha-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }

    .fecha-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding: 0 8px 8px 8px;
    }

    .btn-fecha-limpiar,
    .btn-fecha-aplicar {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--theme-bg-color);
      color: var(--theme-color);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.8rem;
    }

    .btn-fecha-limpiar:hover {
      background: rgba(255, 107, 107, 0.1);
      border-color: #ff6b6b;
      color: #ff6b6b;
    }

    .btn-fecha-aplicar {
      background: rgba(102, 126, 234, 0.2);
      border-color: #667eea;
      color: #667eea;
    }

    .btn-fecha-aplicar:hover {
      background: rgba(102, 126, 234, 0.3);
    }
    </style>

    <script>
    (function(){
      const $$ = (sel, ctx=document) => ctx.querySelector(sel);
      const $$$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

      const overlay = $$("#modalOverlay");
      const modal   = $$("#modalDetalle");
      const btnX    = $$("#m-cerrar");
      const btnSAP  = $$("#btnSAP");
      const estadoActual = $$("#estado-actual");

      window.estadoSeleccionado = "{{ estado_actual or 'por_procesar' }}";

      const fmtMoney = (n) => (n===null || n===undefined) ? "-" : n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
      const fmtDate  = (iso) => {
        if(!iso) return "-";
        const d = new Date(iso);
        if(isNaN(d)) return iso;
        return d.toLocaleString();
      };

      function abrirModal(){ overlay.classList.remove("hidden"); modal.classList.remove("hidden"); }
      function cerrarModal(){ overlay.classList.add("hidden"); modal.classList.add("hidden"); }

      overlay.addEventListener("click", cerrarModal);
      btnX.addEventListener("click", cerrarModal);
      window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") cerrarModal(); });

      async function cargarDetalle(pedidoId){
        const resp = await fetch(`/api/pedidos/${pedidoId}`);
        if(!resp.ok) throw new Error("No se pudo obtener el detalle");
        return resp.json();
      }

      function renderDetalle(data){
        $$("#m-numero").textContent = data.numero_pedido ?? "";
        
        // Mostrar sucursal con indicador de error si es necesario
        const sucursalElement = $$("#m-sucursal");
        if (data.tiene_error_sucursal) {
          // Crear campo editable para sucursal
          const inputSucursal = document.createElement("input");
          inputSucursal.type = "text";
          inputSucursal.className = "campo-sucursal-editable error";
          inputSucursal.value = data.sucursal || "";
          inputSucursal.placeholder = "Ingrese la sucursal";
          inputSucursal.dataset.originalValue = data.sucursal || "";
          sucursalElement.innerHTML = "";
          sucursalElement.appendChild(inputSucursal);
        } else {
          sucursalElement.textContent = data.sucursal || "-";
          sucursalElement.classList.remove("sucursal-error");
        }
        
        $$("#m-fecha").textContent = fmtDate(data.fecha);

        const tb = $$("#m-items");
        tb.innerHTML = "";
        for(const it of (data.items || [])){
          const tr = document.createElement("tr");
          // Agregar clase de error si el producto tiene error
          if (it.tiene_error) {
            tr.classList.add("item-error");
          }
          
          // Crear celdas con campos editables si hay errores
          const tdSku = document.createElement("td");
          const tdDesc = document.createElement("td");
          const tdCant = document.createElement("td");
          
          if (it.tiene_error) {
            // SKU editable
            const inputSku = document.createElement("input");
            inputSku.type = "text";
            inputSku.className = "campo-editable error";
            inputSku.value = it.sku || "";
            inputSku.placeholder = "Ingrese SKU";
            inputSku.dataset.originalValue = it.sku || "";
            tdSku.appendChild(inputSku);
            
            // Descripci√≥n (solo lectura)
            tdDesc.textContent = (it.descripcion || "").replace(/</g,"&lt;");
            
            // Cantidad editable
            const inputCant = document.createElement("input");
            inputCant.type = "number";
            inputCant.className = "campo-editable error";
            inputCant.value = it.cantidad || "";
            inputCant.min = "1";
            inputCant.placeholder = "Cantidad";
            inputCant.dataset.originalValue = it.cantidad || "";
            tdCant.appendChild(inputCant);
          } else {
            // Campos normales (solo lectura)
            tdSku.textContent = it.sku || "";
            tdSku.className = "mono";
            tdDesc.textContent = (it.descripcion || "").replace(/</g,"&lt;");
            tdCant.textContent = it.cantidad ?? "";
            tdCant.className = "num mono";
          }
          
          tr.appendChild(tdSku);
          tr.appendChild(tdDesc);
          tr.appendChild(tdCant);
          tb.appendChild(tr);
        }

        // Mostrar recuadro de verificaci√≥n si hay errores
        const tieneErroresProductos = data.items && data.items.some(item => item.tiene_error);
        const tieneErrorSucursal = data.tiene_error_sucursal;
        const tieneErrores = tieneErroresProductos || tieneErrorSucursal;
        
        const verificacionContainer = $$("#verificacion-container");
        if (tieneErrores) {
          verificacionContainer.style.display = "block";
          
          // Actualizar mensaje seg√∫n el tipo de error
          const mensajeElement = verificacionContainer.querySelector("p");
          if (tieneErrorSucursal && tieneErroresProductos) {
            mensajeElement.textContent = "Este pedido contiene productos que no pudieron ser emparejados correctamente y no se detect√≥ una sucursal v√°lida. Por favor, verifica y corrige los errores antes de procesar.";
          } else if (tieneErrorSucursal) {
            mensajeElement.textContent = "Este pedido no tiene una sucursal v√°lida detectada. Por favor, verifica y corrige este error antes de procesar.";
          } else {
            mensajeElement.textContent = "Este pedido contiene productos que no pudieron ser emparejados correctamente. Por favor, verifica y corrige los errores antes de procesar.";
          }
        } else {
          verificacionContainer.style.display = "none";
        }

      }

      // Funci√≥n para verificar y actualizar pedido
      window.verificarPedido = async function() {
        const pedidoId = window.pedidoActualId;
        if (!pedidoId) {
          alert("Error: No se pudo identificar el pedido");
          return;
        }

        // Recopilar datos editados
        const datosActualizados = {
          sucursal: null,
          items: []
        };

        // Obtener sucursal editada solo si hay error de sucursal
        const inputSucursal = document.querySelector("#m-sucursal .campo-sucursal-editable");
        if (inputSucursal) {
          datosActualizados.sucursal = inputSucursal.value.trim();
        } else {
          // Si no hay campo editable, obtener la sucursal actual del texto
          const sucursalElement = document.querySelector("#m-sucursal");
          if (sucursalElement) {
            datosActualizados.sucursal = sucursalElement.textContent.trim();
          }
        }

        // Obtener items editados
        const filas = document.querySelectorAll("#m-items tr");
        filas.forEach((fila, index) => {
          const inputSku = fila.querySelector(".campo-editable[type='text']");
          const inputCant = fila.querySelector(".campo-editable[type='number']");
          
          if (inputSku && inputCant) {
            datosActualizados.items.push({
              index: index,
              sku: inputSku.value.trim(),
              cantidad: parseInt(inputCant.value) || 0
            });
          }
        });

        // Validar datos
        const errores = [];
        
        // Validar sucursal solo si hay error de sucursal
        // Usar la variable inputSucursal ya declarada arriba
        const tieneErrorSucursal = inputSucursal !== null;
        
        if (tieneErrorSucursal && !datosActualizados.sucursal) {
          errores.push("‚ùå La sucursal es requerida. Por favor, ingrese el nombre de la sucursal.");
        }

        // Validar items
        datosActualizados.items.forEach((item, index) => {
          if (!item.sku) {
            errores.push(`‚ùå Producto ${index + 1}: El SKU es requerido. Por favor, ingrese el SKU del producto.`);
          }
          if (item.cantidad <= 0) {
            errores.push(`‚ùå Producto ${index + 1}: La cantidad debe ser mayor a 0. Por favor, ingrese una cantidad v√°lida.`);
          }
        });

        if (errores.length > 0) {
          alert("‚ùå Errores encontrados:\n\n" + errores.join("\n\n"));
          return;
        }

        // Mostrar indicador de carga
        const btnVerificar = document.getElementById("btn-verificar");
        const textoOriginal = btnVerificar.innerHTML;
        btnVerificar.innerHTML = '<i class="icon">‚è≥</i> Verificando...';
        btnVerificar.disabled = true;

        try {
          // Enviar datos al servidor
          const response = await fetch(`/api/pedidos/${pedidoId}/verificar`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(datosActualizados)
          });

          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          const resultado = await response.json();
          
          if (resultado.exito) {
            alert("‚úÖ Pedido verificado exitosamente. El estado ha cambiado a 'Por procesar'.");
            // Cerrar modal y recargar lista
            cerrarModal();
            window.cargarPedidosPorEstado("con_errores");
          } else {
            alert("‚ùå Error al verificar el pedido: " + (resultado.error || "Error desconocido"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("‚ùå Error al verificar el pedido: " + error.message);
        } finally {
          // Restaurar bot√≥n
          btnVerificar.innerHTML = textoOriginal;
          btnVerificar.disabled = false;
        }
      }

      // Variables globales para filtros
      window.filtrosActuales = {
        cliente_id: null,
        fecha_desde: null,
        fecha_hasta: null
      };

      // Funci√≥n para cargar pedidos por estado con filtros
      window.cargarPedidosPorEstado = async function(estado) {
        try {
          // Construir URL con filtros
          const params = new URLSearchParams();
          if (window.filtrosActuales.cliente_id) {
            params.append('cliente_id', window.filtrosActuales.cliente_id);
          }
          if (window.filtrosActuales.fecha_desde) {
            params.append('fecha_desde', window.filtrosActuales.fecha_desde);
          }
          if (window.filtrosActuales.fecha_hasta) {
            params.append('fecha_hasta', window.filtrosActuales.fecha_hasta);
          }
          
          const url = `/api/pedidos/por_estado/${estado}${params.toString() ? '?' + params.toString() : ''}`;
          const resp = await fetch(url);
          if (!resp.ok) throw new Error("Error al cargar pedidos");
          const data = await resp.json();
          
          const tbody = $$("#ordersTableBody");
          tbody.innerHTML = "";
          
          for (const pedido of data.pedidos) {
            const tr = document.createElement("tr");
            tr.className = "row-pedido";
            tr.setAttribute("data-pedido-id", pedido.id);
            tr.setAttribute("role", "button");
            tr.setAttribute("tabindex", "0");
            tr.setAttribute("title", "Ver detalle");
            
            tr.innerHTML = `
              <td class="mono" data-label="# Pedido">${pedido.numero_pedido}</td>
              <td data-label="Cliente">${pedido.cliente_nombre || 'Roldan'}</td>
              <td data-label="Sucursal">${pedido.sucursal || '-'}</td>
              <td data-label="Fecha">${pedido.fecha ? new Date(pedido.fecha).toLocaleString() : ''}</td>
              <td data-label="Origen">Email</td>
            `;
            
            // Agregar event listeners para el modal
            tr.addEventListener("click", async ()=>{
              try{
                window.pedidoActualId = pedido.id; // Guardar ID del pedido
                const data = await cargarDetalle(pedido.id);
                renderDetalle(data);
                abrirModal();
              }catch(e){
                console.error(e);
                alert("No se pudo cargar el detalle del pedido.");
              }
            });
            tr.addEventListener("keydown", (e)=>{
              if(e.key==="Enter" || e.key===" "){ 
                e.preventDefault(); 
                window.pedidoActualId = pedido.id; // Guardar ID del pedido
                tr.click(); 
              }
            });
            
            tbody.appendChild(tr);
          }
          
          estadoActual.textContent = estado;
          window.estadoSeleccionado = estado;
          
          // Mostrar/ocultar bot√≥n SAP
          if (estado === "por_procesar") {
            btnSAP.classList.remove("hidden");
          } else {
            btnSAP.classList.add("hidden");
          }
          
        } catch (error) {
          console.error("Error:", error);
          alert("Error al cargar los pedidos");
        }
      }

      // Event listeners para las subpesta√±as
      $$$(".main-header-link").forEach(link => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const estado = link.getAttribute("data-estado");
          
          // Actualizar estado activo
          $$$(".main-header-link").forEach(l => l.classList.remove("is-active"));
          link.classList.add("is-active");
          
          // Cargar pedidos del estado seleccionado
          window.cargarPedidosPorEstado(estado);
        });
      });

      // Event listener para el bot√≥n SAP
      btnSAP.addEventListener("click", async () => {
        if (!confirm("¬øGenerar archivos SAP para todos los pedidos por procesar?")) {
          return;
        }
        
        btnSAP.disabled = true;
        btnSAP.textContent = "Generando...";
        
        try {
          const resp = await fetch("/api/generar_sap", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            }
          });
          
          const data = await resp.json();
          
          if (data.ok) {
            alert(`‚úÖ ${data.mensaje}\n\nArchivos generados:\n- ${data.archivos.odrf}\n- ${data.archivos.drf1}`);
            // Recargar pedidos por procesar
            window.cargarPedidosPorEstado("por_procesar");
          } else {
            alert(`‚ùå ${data.mensaje || data.error}`);
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error al generar archivos SAP");
        } finally {
          btnSAP.disabled = false;
          btnSAP.innerHTML = "<span>SAP</span>";
        }
      });

      // Inicializar con el estado actual
      const linkActivo = $$(`[data-estado="${window.estadoSeleccionado}"]`);
      if (linkActivo) {
        linkActivo.classList.add("is-active");
      }
      
      // Mostrar/ocultar bot√≥n SAP seg√∫n estado inicial
      if (window.estadoSeleccionado === "por_procesar") {
        btnSAP.classList.remove("hidden");
      }
    })();
    </script>

    <script>
    // Sistema de filtros con dropdowns
    (function(){
      const $$ = (sel, ctx=document) => ctx.querySelector(sel);
      const $$$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

      // Elementos del DOM
      const filterCliente = $$("#filter-cliente");
      const filterDesde = $$("#filter-desde");
      const filterHasta = $$("#filter-hasta");
      
      const dropdownCliente = $$("#dropdown-cliente");
      const dropdownDesde = $$("#dropdown-desde");
      const dropdownHasta = $$("#dropdown-hasta");
      
      const clientesContainer = $$("#clientes-container");
      const fechaDesdeInput = $$("#fecha-desde-input");
      const fechaHastaInput = $$("#fecha-hasta-input");

      // Variables globales
      let clientesLista = [];
      let clienteSeleccionado = null;
      let fechaDesdeSeleccionada = null;
      let fechaHastaSeleccionada = null;

      // Funci√≥n para cerrar todos los dropdowns
      function cerrarTodosLosDropdowns() {
        $$$(".filter-dropdown").forEach(dropdown => {
          dropdown.classList.remove("show");
        });
      }

      // Funci√≥n para actualizar la visualizaci√≥n de filtros
      function actualizarVisualizacionFiltros() {
        // Actualizar pastilla de cliente
        const clienteValue = $$("#filter-cliente .filter-value");
        if (clienteSeleccionado) {
          clienteValue.textContent = clienteSeleccionado.nombre;
          filterCliente.classList.add("active");
        } else {
          clienteValue.textContent = "Todos";
          filterCliente.classList.remove("active");
        }

        // Actualizar pastilla de fecha desde
        const desdeValue = $$("#filter-desde .filter-value");
        if (fechaDesdeSeleccionada) {
          desdeValue.textContent = new Date(fechaDesdeSeleccionada).toLocaleDateString();
          filterDesde.classList.add("active");
        } else {
          desdeValue.textContent = "Todos";
          filterDesde.classList.remove("active");
        }

        // Actualizar pastilla de fecha hasta
        const hastaValue = $$("#filter-hasta .filter-value");
        if (fechaHastaSeleccionada) {
          hastaValue.textContent = new Date(fechaHastaSeleccionada).toLocaleDateString();
          filterHasta.classList.add("active");
        } else {
          hastaValue.textContent = "Todos";
          filterHasta.classList.remove("active");
        }
      }

      // Funci√≥n para aplicar filtros
      function aplicarFiltros() {
        // Actualizar filtros globales
        window.filtrosActuales = {
          cliente_id: clienteSeleccionado ? clienteSeleccionado.id : null,
          fecha_desde: fechaDesdeSeleccionada,
          fecha_hasta: fechaHastaSeleccionada
        };

        // Recargar pedidos del estado actual
        if (window.cargarPedidosPorEstado) {
          window.cargarPedidosPorEstado(window.estadoSeleccionado || "por_procesar");
        }
      }

      // Funci√≥n para cargar clientes
      async function cargarClientes() {
        try {
          const resp = await fetch("/api/clientes");
          if (!resp.ok) throw new Error("Error al cargar clientes");
          const data = await resp.json();
          clientesLista = data.clientes;
          
          // Renderizar lista de clientes
          clientesContainer.innerHTML = "";
          clientesLista.forEach(cliente => {
            const div = document.createElement("div");
            div.className = "cliente-option";
            div.setAttribute("data-cliente-id", cliente.id);
            div.innerHTML = `<span class="cliente-nombre">${cliente.nombre}</span>`;
            clientesContainer.appendChild(div);
          });
        } catch (error) {
          console.error("Error al cargar clientes:", error);
        }
      }

      // Event listeners para pastillas de filtros
      filterCliente.addEventListener("click", (e) => {
        e.stopPropagation();
        cerrarTodosLosDropdowns();
        dropdownCliente.classList.toggle("show");
      });

      filterDesde.addEventListener("click", (e) => {
        e.stopPropagation();
        cerrarTodosLosDropdowns();
        dropdownDesde.classList.toggle("show");
      });

      filterHasta.addEventListener("click", (e) => {
        e.stopPropagation();
        cerrarTodosLosDropdowns();
        dropdownHasta.classList.toggle("show");
      });

      // Event listener para cerrar dropdowns al hacer clic fuera
      document.addEventListener("click", () => {
        cerrarTodosLosDropdowns();
      });

      // Event listeners para selecci√≥n de cliente
      dropdownCliente.addEventListener("click", (e) => {
        const clienteOption = e.target.closest(".cliente-option");
        if (clienteOption) {
          const clienteId = parseInt(clienteOption.getAttribute("data-cliente-id"));
          
          // Actualizar selecci√≥n visual
          $$$(".cliente-option").forEach(opt => opt.classList.remove("selected"));
          clienteOption.classList.add("selected");
          
          // Guardar selecci√≥n
          if (clienteId === 0) {
            clienteSeleccionado = null;
          } else {
            clienteSeleccionado = clientesLista.find(c => c.id === clienteId);
          }
          
          // Aplicar filtros y cerrar dropdown
          actualizarVisualizacionFiltros();
          aplicarFiltros();
          cerrarTodosLosDropdowns();
        }
      });

      // Event listeners para fechas
      $$("#btn-aplicar-desde").addEventListener("click", () => {
        const fecha = fechaDesdeInput.value;
        fechaDesdeSeleccionada = fecha || null;
        actualizarVisualizacionFiltros();
        aplicarFiltros();
        cerrarTodosLosDropdowns();
      });

      $$("#btn-limpiar-desde").addEventListener("click", () => {
        fechaDesdeSeleccionada = null;
        fechaDesdeInput.value = "";
        actualizarVisualizacionFiltros();
        aplicarFiltros();
        cerrarTodosLosDropdowns();
      });

      $$("#btn-aplicar-hasta").addEventListener("click", () => {
        const fecha = fechaHastaInput.value;
        fechaHastaSeleccionada = fecha || null;
        actualizarVisualizacionFiltros();
        aplicarFiltros();
        cerrarTodosLosDropdowns();
      });

      $$("#btn-limpiar-hasta").addEventListener("click", () => {
        fechaHastaSeleccionada = null;
        fechaHastaInput.value = "";
        actualizarVisualizacionFiltros();
        aplicarFiltros();
        cerrarTodosLosDropdowns();
      });

      // Event listeners para botones de limpiar en las pastillas
      $$("#filter-cliente .filter-clear").addEventListener("click", (e) => {
        e.stopPropagation();
        clienteSeleccionado = null;
        actualizarVisualizacionFiltros();
        aplicarFiltros();
      });

      $$("#filter-desde .filter-clear").addEventListener("click", (e) => {
        e.stopPropagation();
        fechaDesdeSeleccionada = null;
        actualizarVisualizacionFiltros();
        aplicarFiltros();
      });

      $$("#filter-hasta .filter-clear").addEventListener("click", (e) => {
        e.stopPropagation();
        fechaHastaSeleccionada = null;
        actualizarVisualizacionFiltros();
        aplicarFiltros();
      });

      // Inicializar
      cargarClientes();
      actualizarVisualizacionFiltros();
    })();
    </script>

    <script>
    // Configuraci√≥n de n√∫mero de pedido inicial
    (function(){
      const numeroPedidoInicial = document.getElementById("numeroPedidoInicial");
      const btnGuardarNumero = document.getElementById("btnGuardarNumero");

      // Cargar n√∫mero de pedido inicial al inicializar
      async function cargarNumeroPedidoInicial() {
          try {
              const response = await fetch('/api/configuracion/numero-pedido-inicial');
              if (response.ok) {
                  const data = await response.json();
                  numeroPedidoInicial.value = data.numero_inicial || '';
              }
          } catch (error) {
              console.error('Error al cargar n√∫mero de pedido inicial:', error);
          }
      }

      // Guardar n√∫mero de pedido inicial
      async function guardarNumeroPedidoInicial() {
          const numero = numeroPedidoInicial.value;
          
          if (!numero || numero < 1) {
              alert('‚ùå Error: N√∫mero de pedido inv√°lido.\n\nPor favor, ingrese un n√∫mero mayor a 0 para el pedido inicial.');
              return;
          }

          try {
              const response = await fetch('/api/configuracion/numero-pedido-inicial', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ numero_inicial: parseInt(numero) })
              });

              if (response.ok) {
                  alert(`‚úÖ N√∫mero de pedido inicial guardado: ${numero}`);
              } else {
                  const error = await response.json();
                  alert(`‚ùå Error: ${error.error}`);
              }
          } catch (error) {
              console.error('Error al guardar n√∫mero de pedido inicial:', error);
              alert('‚ùå Error al guardar la configuraci√≥n');
          }
      }

      // Event listeners
      btnGuardarNumero.addEventListener("click", guardarNumeroPedidoInicial);
      
      // Permitir guardar con Enter
      numeroPedidoInicial.addEventListener("keypress", (e) => {
          if (e.key === 'Enter') {
              guardarNumeroPedidoInicial();
          }
      });

      // Cargar configuraci√≥n al inicializar
      cargarNumeroPedidoInicial();
    })();
    </script>

    <script>
    // B√∫squeda r√°pida en la tabla
    (function(){
      const input = document.getElementById('quickSearch');
      const rows = () => Array.from(document.querySelectorAll('#ordersTable tbody tr'));
      function normalize(s){ return (s||'').toString().toLowerCase(); }
      input.addEventListener('input', ()=>{
        const q = normalize(input.value);
        rows().forEach(tr => {
          const text = normalize(tr.innerText);
          tr.style.display = text.includes(q) ? '' : 'none';
        });
      });
    })();
  </script>
  </body>
</html>