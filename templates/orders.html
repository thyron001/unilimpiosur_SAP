<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedidos — Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/glass.css') }}">
</head>
<body class="bg">
  <div class="app-shell">
    <header class="topbar glass">
      <div class="brand">
        <span class="dot red"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
        <h1>Pedidos</h1>
      </div>

      <!-- Indicador global de nuevos -->
      <div class="new-indicator" id="globalNewIndicator" aria-live="polite" hidden>
        <span class="ping"></span>
        <span class="label">¡Nuevo!</span>
      </div>
    </header>

    <main class="content">
      <section class="card glass">
        <div class="card-head">
          <h2>Pedidos entrantes</h2>
          <div class="legend">
            <span class="badge badge-new">Nuevo</span>
            <span class="legend-text">= recibido hace &lt; 5 min</span>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table glass-table" id="ordersTable">
            <thead>
              <tr>
                <th># Pedido</th>
                <th>Cliente</th>
                <th>Sucursal</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Origen</th>
              </tr>
            </thead>
            <tbody>
              {% for o in orders %}
              {% set is_new = (now - o.fecha).total_seconds() < 300 %}
              <tr class="{{ 'row-new' if is_new }}">
                <td class="mono">
                  {{ o.numero_pedido }}
                  {% if is_new %}
                    <span class="badge badge-new">Nuevo</span>
                  {% endif %}
                </td>
                <td>Roldan</td>
                <td>Cuenca</td>
                <td>{{ o.fecha.strftime('%Y-%m-%d %H:%M:%S') if o.fecha else '' }}</td>
                <td class="mono">{{ "{:,.2f}".format(o.total or 0) }}</td>
                <td>Email</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Mini polling para avisar de nuevos pedidos (opcional) -->
  <script>
    (function () {
      let lastCount = {{ orders|length }};
      const badge = document.getElementById('globalNewIndicator');

      async function checkNew() {
        try {
          const r = await fetch('/api/orders/summary', { cache: 'no-store' });
          if (!r.ok) return;
          const data = await r.json();
          const count = Number(data.count || 0);
          if (count > lastCount) {
            badge.hidden = false;        // muestra “¡Nuevo!”
            lastCount = count;
            // Opcional: puedes recargar la página o pedir solo las filas nuevas
            // location.reload();
          }
        } catch (e) {
          // Silencioso
        }
      }
      setInterval(checkNew, 10000); // cada 10s
    })();
  </script>
</body>
</html>
